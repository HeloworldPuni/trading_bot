//@version=6
indicator("Stock Predictor Signals", overlay=true)

// Input arrays from Python model
bullish_signals = array.from(14, 28, 44, 54, 76, 83, 88, 90, 95, 101, 103, 106, 108, 118, 131, 135, 139, 157, 159, 178, 185, 189, 204, 205, 207, 209, 214, 218, 230, 232, 240, 252, 257, 259, 261, 267, 268, 270, 276, 282, 297, 303, 305, 310, 329, 349, 365, 368, 369, 381, 393, 405, 407, 412, 420, 422, 431, 443, 445, 464, 468, 470, 473, 476, 480, 500, 501, 506, 523, 525, 534, 538, 542, 557, 561, 572, 578, 583, 586, 589, 596, 601, 606, 608, 612, 617, 623, 638, 640, 651, 652, 658, 660, 663, 665, 668, 687, 693, 699, 703, 710, 716, 718, 731, 744, 747, 755, 756, 773, 775, 778, 807, 816, 819, 831, 852, 855, 860, 869, 879, 881, 886, 888, 889, 896, 898, 902, 907, 908, 912, 921, 926, 930, 936, 939, 941, 947, 957, 962, 977, 981, 987, 988, 997, 1018, 1020, 1038, 1048, 1049, 1058, 1060, 1069, 1074, 1081, 1091, 1121, 1129, 1160, 1163, 1171, 1173, 1176, 1183, 1188, 1214, 1215, 1225, 1232, 1242, 1245)

bearish_signals = array.from(7, 9, 19, 20, 25, 29, 30, 31, 35, 38, 48, 49, 50, 62, 75, 78, 84, 85, 91, 99, 102, 104, 115, 116, 120, 122, 124, 130, 132, 136, 138, 140, 143, 146, 147, 149, 153, 168, 170, 171, 197, 203, 206, 225, 229, 233, 235, 236, 245, 247, 248, 253, 277, 278, 287, 294, 307, 312, 318, 322, 335, 339, 348, 351, 354, 361, 375, 385, 401, 440, 450, 457, 460, 461, 471, 474, 491, 493, 496, 504, 517, 553, 576, 590, 592, 613, 621, 630, 636, 664, 671, 673, 677, 684, 689, 696, 704, 705, 715, 717, 720, 725, 728, 738, 741, 759, 764, 769, 771, 772, 791, 792, 800, 801, 803, 806, 813, 823, 832, 841, 843, 848, 850, 853, 854, 858, 868, 874, 877, 882, 892, 895, 903, 905, 917, 919, 923, 924, 945, 946, 955, 960, 963, 964, 966, 974, 975, 980, 984, 991, 992, 1003, 1007, 1008, 1012, 1022, 1028, 1032, 1034, 1039, 1052, 1059, 1061, 1062, 1068, 1070, 1080, 1084, 1090, 1093, 1098, 1103, 1104, 1111, 1114, 1133, 1135, 1141, 1143, 1149, 1154, 1156, 1161, 1167, 1186, 1203, 1209, 1216, 1217, 1219, 1221, 1227, 1237, 1238, 1249, 1252)

pred_prices = array.from(313.1, 314.2, 314.1, 314.1, 314.1, 315.6, 316.0, 317.0, 318.7, 320.0, 320.7, 321.4, 322.2, 322.8, 322.4, 322.1, 322.0, 321.9, 322.1, 322.5, 321.3, 320.5, 317.6, 315.6, 313.4, 312.7, 312.8, 312.9, 314.8, 317.4, 317.7, 319.5, 323.8, 326.8, 330.2, 333.2, 335.8, 337.4, 338.6, 337.8, 337.5, 337.8, 338.8, 340.3, 340.0, 339.7, 340.3, 340.7, 341.5, 342.3, 343.2, 342.8, 342.5, 342.3, 341.7, 341.5, 341.7, 343.8, 344.3, 343.8, 344.4, 345.2, 346.5, 349.1, 351.3, 353.1, 353.7, 350.9, 350.6, 350.2, 351.9, 354.3, 357.2, 359.5, 361.5, 362.7, 361.0, 360.9, 361.3, 362.4, 363.2, 363.3, 364.1, 361.4, 359.7, 357.0, 356.4, 357.7, 359.9, 362.4, 364.5, 367.0, 369.3, 370.1, 370.9, 371.3, 371.5, 371.5, 371.2, 369.9, 368.7, 366.4, 366.2, 363.5, 360.5, 360.7, 362.3, 362.5, 359.8, 358.5, 358.9, 360.5, 363.0, 366.3, 370.0, 372.9, 374.6, 375.2, 374.0, 372.4, 372.4, 372.1, 371.3, 370.0, 369.7, 370.2, 371.5, 372.2, 373.2, 375.4, 378.5, 381.6, 384.1, 385.8, 387.0, 387.8, 387.9, 388.1, 387.9, 387.5, 386.9, 387.1, 386.3, 386.8, 388.5, 390.3, 391.7, 391.9, 391.3, 391.4, 390.0, 390.0, 390.2, 391.6, 391.9, 390.1, 386.5, 384.8, 385.4, 387.1, 388.7, 388.0, 388.2, 388.4, 390.0, 391.4, 393.0, 393.7, 394.0, 394.1, 394.3, 394.1, 394.6, 395.5, 396.6, 397.4, 397.9, 398.5, 399.2, 399.4, 398.2, 396.6, 393.1, 392.7, 394.1, 396.2, 398.6, 400.5, 402.2, 404.1, 404.6, 405.4, 406.2, 406.5, 407.0, 406.1, 406.1, 408.0, 409.6, 410.8, 411.6, 411.0, 406.5, 404.6, 405.4, 407.6, 409.8, 412.6, 414.0, 415.2, 416.4, 416.3, 416.1, 416.2, 416.6, 417.3, 417.8, 418.2, 418.4, 418.5, 418.9, 419.2, 418.3, 416.4, 414.8, 413.5, 413.7, 415.4, 417.9, 420.0, 420.8, 421.3, 423.1, 424.4, 425.8, 427.6, 428.6, 428.8, 428.5, 426.9, 423.6, 421.0, 419.2, 418.2, 417.8, 416.0, 411.7, 410.5, 410.6, 412.5, 415.3, 417.6, 415.7, 415.1, 411.8, 409.4, 407.1, 407.2, 407.7, 410.2, 412.6, 414.6, 415.2, 415.3, 415.8, 416.7, 417.8, 420.5, 423.5, 426.6, 428.4, 430.1, 431.1, 430.9, 431.6, 431.8, 432.8, 434.0, 435.1, 436.2, 437.1, 438.6, 439.9, 439.6, 440.2, 440.6, 441.2, 441.8, 442.3, 442.7, 442.6, 441.8, 441.1, 441.2, 438.4, 437.0, 433.2, 429.7, 428.0, 426.9, 428.2, 431.1, 435.2, 438.7, 441.1, 441.6, 440.7, 439.4, 438.0, 435.7, 434.5, 435.9, 438.5, 441.3, 444.0, 446.4, 447.9, 448.6, 448.3, 449.3, 449.3, 447.0, 445.3, 443.9, 441.4, 441.4, 442.5, 441.8, 440.7, 438.4, 435.8, 432.3, 424.6, 415.9, 412.0, 409.4, 408.9, 409.6, 412.6, 417.6, 422.9, 425.2, 426.8, 428.8, 430.8, 432.2, 430.3, 425.8, 422.4, 421.5, 421.5, 420.4, 417.7, 414.6, 410.4, 404.5, 404.2, 404.9, 405.5, 407.7, 410.3, 411.4, 409.4, 404.6, 403.4, 404.0, 404.1, 403.4, 403.1, 402.8, 404.9, 407.8, 411.3, 416.6, 419.6, 423.5, 426.5, 429.2, 431.1, 432.4, 431.3, 431.1, 432.6, 433.2, 431.3, 430.7, 430.1, 427.5, 424.8, 423.1, 420.6, 419.7, 419.2, 419.6, 418.9, 415.0, 411.6, 408.1, 404.3, 403.1, 399.4, 395.3, 394.8, 395.4, 393.5, 391.9, 389.0, 386.9, 384.5, 382.8, 383.1, 384.2, 385.8, 384.6, 382.6, 379.3, 378.9, 378.5, 378.5, 379.8, 382.7, 384.9, 386.3, 388.9, 390.4, 391.9, 393.8, 394.4, 392.6, 387.1, 378.8, 373.3, 369.0, 364.6, 361.8, 361.9, 362.4, 363.5, 365.5, 368.3, 369.7, 370.9, 369.5, 369.3, 369.4, 369.9, 371.4, 372.3, 373.0, 373.1, 371.5, 369.3, 368.6, 368.9, 369.9, 371.7, 374.4, 376.2, 378.0, 379.2, 379.8, 380.9, 382.4, 384.5, 386.4, 388.9, 392.1, 394.5, 395.6, 396.1, 396.8, 397.9, 399.8, 402.3, 404.9, 406.4, 408.0, 408.0, 405.9, 403.8, 402.5, 402.0, 398.0, 394.8, 390.8, 387.4, 384.6, 381.6, 379.9, 379.4, 379.7, 381.0, 383.3, 382.0, 381.3, 380.4, 378.5, 378.0, 377.2, 374.5, 371.9, 368.2, 365.2, 362.3, 360.5, 358.8, 354.0, 353.3, 354.8, 357.5, 360.1, 360.4, 358.8, 355.7, 352.8, 350.6, 347.8, 348.4, 350.8, 354.0, 356.1, 356.9, 359.5, 362.9, 365.1, 367.1, 369.0, 370.2, 371.2, 369.6, 368.3, 367.0, 367.6, 368.4, 368.3, 367.9, 370.2, 373.2, 376.0, 378.4, 380.0, 380.3, 381.5, 382.9, 384.0, 386.1, 385.8, 385.2, 382.8, 382.8, 383.5, 384.1, 383.9, 383.6, 383.5, 382.5, 382.3, 381.0, 380.4, 378.9, 376.7, 375.8, 375.4, 375.7, 374.7, 374.9, 375.4, 374.3, 373.8, 372.8, 372.1, 371.4, 371.0, 370.7, 371.8, 373.7, 376.1, 377.8, 380.1, 382.2, 381.7, 380.7, 380.4, 381.0, 382.8, 383.7, 385.0, 386.4, 387.0, 387.5, 388.3, 390.2, 392.1, 394.7, 396.2, 397.4, 397.1, 396.7, 397.2, 397.1, 397.9, 397.3, 395.7, 393.5, 391.3, 389.1, 386.6, 385.6, 384.5, 383.1, 383.0, 383.5, 384.9, 384.7, 385.3, 383.8, 379.0, 375.0, 373.1, 371.6, 372.7, 374.1, 377.6, 381.3, 382.9, 383.1, 383.6, 385.2, 387.0, 388.0, 389.0, 389.4, 391.5, 393.7, 394.7, 395.9, 396.9, 397.7, 397.2, 396.8, 396.8, 397.8, 399.0, 400.4, 400.4, 400.1, 400.0, 397.7, 395.7, 394.8, 395.4, 397.7, 397.8, 396.9, 395.6, 395.6, 397.4, 399.3, 399.1, 399.4, 399.5, 400.2, 400.6, 400.3, 400.3, 400.1, 402.0, 402.4, 401.8, 401.2, 401.6, 403.1, 403.0, 403.8, 405.6, 408.5, 411.3, 412.7, 414.4, 415.0, 415.7, 415.9, 415.9, 417.4, 418.8, 421.4, 422.7, 424.4, 423.8, 423.2, 422.7, 423.1, 424.1, 424.4, 427.7, 429.9, 430.3, 429.6, 429.9, 430.4, 430.1, 430.9, 432.0, 433.9, 434.7, 436.3, 437.1, 437.5, 438.5, 439.7, 440.2, 439.1, 439.0, 440.0, 441.4, 440.2, 439.6, 437.5, 437.4, 437.0, 436.2, 434.8, 434.5, 435.4, 435.0, 433.5, 430.1, 427.4, 426.9, 427.1, 428.1, 427.5, 426.8, 428.1, 429.3, 431.2, 433.1, 434.9, 436.3, 436.4, 435.9, 435.7, 435.7, 435.3, 435.2, 434.5, 432.4, 432.9, 433.2, 432.6, 429.3, 425.7, 423.9, 421.4, 418.8, 417.5, 415.8, 415.7, 414.9, 414.9, 415.7, 415.2, 416.0, 417.3, 420.0, 421.0, 420.5, 421.5, 422.8, 422.0, 419.4, 415.9, 414.0, 413.8, 412.7, 410.1, 407.2, 406.1, 406.4, 407.0, 408.6, 410.5, 414.6, 418.9, 422.7, 423.4, 424.5, 427.1, 428.3, 430.1, 432.3, 433.6, 435.6, 438.3, 440.2, 442.8, 443.9, 443.9, 443.5, 442.5, 441.4, 441.3, 441.7, 442.0, 442.7, 442.8, 443.7, 444.7, 446.7, 448.3, 449.2, 453.5, 458.7, 460.8, 462.7, 465.0, 467.4, 468.7, 469.0, 466.9, 464.7, 463.5, 463.6, 463.8, 464.9, 466.4, 467.6, 468.1, 469.0, 468.5, 468.2, 467.2, 466.0, 466.9, 469.4, 470.4, 471.6, 472.4, 473.9, 475.3, 472.9, 472.1, 472.1, 473.3, 475.7, 480.4, 485.9, 490.2, 493.6, 489.8, 490.4, 492.3, 493.4, 494.3, 495.3, 496.5, 498.4, 500.4, 502.2, 503.0, 502.2, 502.1, 503.5, 503.5, 503.7, 504.7, 504.2, 504.8, 505.3, 506.6, 505.2, 503.7, 503.7, 505.7, 508.4, 511.5, 513.1, 515.4, 515.3, 516.3, 515.7, 516.6, 515.8, 516.3, 513.6, 512.4, 512.8, 513.3, 512.0, 511.3, 509.4, 507.1, 506.0, 504.5, 503.0, 497.2, 496.2, 497.5, 499.8, 501.0, 502.4, 504.5, 503.7, 502.2, 502.2, 502.6, 504.7, 506.7, 508.8, 511.3, 513.1, 515.1, 517.1, 519.5, 522.3, 524.3, 527.1, 529.6, 530.7, 530.5, 531.1, 531.8, 531.7, 529.8, 527.0, 527.1, 528.6, 529.9, 531.9, 533.0, 534.1, 535.0, 534.8, 535.6, 536.7, 537.3, 538.6, 538.4, 538.4, 539.3, 540.6, 541.6, 542.6, 541.1, 541.4, 542.1, 543.3, 544.2, 545.2, 546.5, 547.4, 547.0, 546.9, 547.6, 550.4, 550.3, 549.3, 547.5, 547.3, 547.7, 545.1, 543.0, 541.9, 542.1, 541.8, 541.1, 539.8, 537.6, 529.2, 526.8, 525.0, 526.1, 528.9, 531.6, 533.9, 536.4, 538.1, 540.4, 543.1, 545.5, 547.0, 547.1, 547.5, 548.6, 549.7, 549.8, 549.8, 548.9, 547.5, 546.8, 546.3, 543.9, 543.5, 543.8, 542.6, 543.4, 545.2, 547.3, 548.4, 548.5, 549.9, 551.8, 555.6, 559.2, 562.3, 564.4, 565.9, 566.1, 565.2, 566.1, 566.7, 567.2, 567.0, 567.5, 568.3, 568.7, 569.3, 574.1, 574.2, 574.8, 574.9, 578.4, 581.9, 585.0, 582.6, 580.2, 577.3, 575.9, 574.4, 573.4, 571.0, 569.7, 569.1, 569.2, 572.7, 578.4, 583.9, 589.0, 592.5, 594.6, 596.0, 594.2, 594.5, 594.2, 594.0, 594.2, 595.1, 595.9, 596.6, 597.7, 599.0, 600.1, 601.1, 601.3, 602.1, 602.7, 602.8, 602.4, 602.8, 602.8, 602.6, 602.1, 601.0, 596.2, 593.2, 589.6, 591.4, 595.3, 598.5, 599.0, 598.7, 597.9, 597.0, 597.3, 597.4, 596.4, 596.1, 590.3, 589.6, 589.7, 590.6, 592.3, 593.5, 595.9, 597.9, 601.3, 603.6, 602.6, 602.9, 603.4, 603.7, 602.3, 600.7, 601.4, 602.5, 603.3, 602.7, 603.5, 604.1, 603.5, 604.5, 606.7, 608.9, 610.6, 611.5, 608.2, 605.9, 603.4, 602.1, 598.8, 595.9, 594.0, 586.8, 586.2, 582.2, 578.6, 572.2, 566.3, 562.5, 558.8, 558.6, 560.3, 559.5, 560.2, 561.1, 561.1, 563.1, 566.3, 567.8, 569.0, 565.7, 560.8, 560.2, 559.7, 553.8, 538.7, 522.8, 513.7, 510.3, 513.0, 520.7, 529.8, 537.4, 540.2, 540.9, 538.5, 536.8, 535.2, 536.5, 538.6, 541.3, 543.8, 543.6, 544.9, 548.5, 553.1, 554.8, 556.6, 557.9, 560.4, 565.4, 571.6, 577.5, 582.2, 585.9, 589.3, 592.1, 591.4, 591.6, 591.1, 591.5, 592.1, 592.7, 592.1, 593.4, 594.8, 596.3, 595.4, 596.3, 598.0, 599.0, 599.3, 600.1, 599.0, 598.8, 598.4, 598.4, 597.5, 597.5, 600.4, 603.8, 606.3, 608.5, 610.4, 613.3, 616.2)

// Input controls
show_signals = input.bool(true, title="Show Exhaustion Signal")
show_predictions = input.bool(true, title="Show Predicted Prices")
show_levels = input.bool(true, title="Show Support/Resistance Levels")
level_color = input.color(color.new(#7da7f0, 50), title="Level Color")
dashOn = input.bool(true, "Dashboard On / Off")
dashDist = input.int(13, "Dashboard Distance")
dashColor = input.color(color.new(#696969, 80), "Dashboard Color", inline="Dash Line")
dashTextColor = input.color(color.new(#ffffff, 0), "Text Color", inline="Dash Line")

// Get the last 100 bars of data
lookback = 100
current_bar = bar_index
start_bar = math.max(0, current_bar - lookback)

// Create sliced arrays for recent data
recent_bullish = array.new_int()
recent_bearish = array.new_int()
recent_prices = array.new_float()

// Fill recent arrays with data from the last 100 bars
for i = 0 to array.size(bullish_signals) - 1
    if array.get(bullish_signals, i) >= start_bar
        array.push(recent_bullish, array.get(bullish_signals, i))

for i = 0 to array.size(bearish_signals) - 1
    if array.get(bearish_signals, i) >= start_bar
        array.push(recent_bearish, array.get(bearish_signals, i))

for i = 0 to array.size(pred_prices) - 1
    if i >= start_bar
        array.push(recent_prices, array.get(pred_prices, i))

// Plot standard indicators
plot(ta.sma(close, 20), title='SMA20', color=#038bd9)
plot(ta.sma(close, 50), title='SMA50', color=#e3ba4b)
plot(ta.sma(close, 100), title='SMA100', color=#96f783)
plot(ta.sma(close, 200), title='SMA200', color=#96f783)
plot(ta.ema(close, 9), title='EMA9', color=#7da7f0)
plot(ta.vwap(close), title='VWAP', color=#e69061)

// Calculate market indicators based on image formulas

// Calculates Volatility for Dashboard
atrVal = ta.atr(14)
stdAtr = 2 * ta.stdev(atrVal, 20)
smaAtr = ta.sma(atrVal, 20)
topAtrDev = smaAtr + stdAtr
bottomAtrDev = smaAtr - stdAtr
calcDev = (atrVal - bottomAtrDev) / (topAtrDev - bottomAtrDev)
percentVol = (40 * calcDev + 30)

// Calculates Volume for Dashboard
volumeDash = volume

// RSI for Dashboard
rsiDash = ta.rsi(close, 14)

// Calculates Sentiment for Dashboard
ema9Val = ta.ema(close, 9)
totalSentTxt = ema9Val > ema9Val[2] ? "Bullish" : ema9Val < ema9Val[2] ? "Bearish" : "Flat"

// Support and Resistance Levels
support_levels = array.new_float()
resistance_levels = array.new_float()

// Plot support and resistance levels
if show_levels
    // Calculate support and resistance levels dynamically
    lookback = 100
    highest = ta.highest(high, lookback)
    lowest = ta.lowest(low, lookback)
    price_range = highest - lowest
    
    // Calculate levels
    for i = 1 to 5
        support = lowest + (price_range * (i-1) / 5)
        resistance = lowest + (price_range * i / 5)
        array.push(support_levels, support)
        array.push(resistance_levels, resistance)
    
    // Plot the levels
    for i = 0 to array.size(support_levels) - 1
        level = array.get(support_levels, i)
        line.new(bar_index - lookback, level, bar_index, level, color=color.new(#96f783, 50), style=line.style_dashed)
        label.new(bar_index, level, text="S" + str.tostring(i+1), color=color.new(#96f783, 50), style=label.style_label_left, textcolor=color.white)

    for i = 0 to array.size(resistance_levels) - 1
        level = array.get(resistance_levels, i)
        line.new(bar_index - lookback, level, bar_index, level, color=color.new(#e69061, 50), style=line.style_dashed)
        label.new(bar_index, level, text="R" + str.tostring(i+1), color=color.new(#e69061, 50), style=label.style_label_left, textcolor=color.white)

// Create dashboard table
var table dashboard = table.new(position.top_right, 2, 5, border_width=1)

// Update dashboard values

if dashOn
    table.cell(dashboard, 0, 0, "RSI", bgcolor=dashColor, text_color=dashTextColor)
    table.cell(dashboard, 1, 0, str.tostring(rsiDash, "#.##"), bgcolor=dashColor, text_color=dashTextColor)
    
    table.cell(dashboard, 0, 1, "Volatility", bgcolor=dashColor, text_color=dashTextColor)
    table.cell(dashboard, 1, 1, str.tostring(percentVol, "#.##"), bgcolor=dashColor, text_color=dashTextColor)
    
    table.cell(dashboard, 0, 2, "Volume", bgcolor=dashColor, text_color=dashTextColor)
    table.cell(dashboard, 1, 2, str.tostring(volumeDash, "#.##"), bgcolor=dashColor, text_color=dashTextColor)
    
    table.cell(dashboard, 0, 3, "Recent Signals", bgcolor=dashColor, text_color=dashTextColor)
    table.cell(dashboard, 1, 3, "B: " + str.tostring(array.size(recent_bullish)) + " S: " + str.tostring(array.size(recent_bearish)), bgcolor=dashColor, text_color=dashTextColor)
    
    table.cell(dashboard, 0, 4, "Sentiment", bgcolor=dashColor, text_color=dashTextColor)
    table.cell(dashboard, 1, 4, totalSentTxt, bgcolor=dashColor, text_color=dashTextColor)


// Plot signals
plotshape( show_signals and array.includes(recent_bullish, bar_index),title="Bullish Exhaustion",location=location.belowbar,color=color.green,style=shape.triangleup,size=size.normal)
    

plotshape(show_signals and array.includes(recent_bearish, bar_index), title="Bearish Exhaustion", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.normal)
    

// Plot predicted prices
var line[] prediction_lines = array.new_line()
if show_predictions and array.size(recent_prices) > 0
    for i = 0 to array.size(recent_prices) - 1
        price = array.get(recent_prices, i)
        line.new(x1=bar_index,  y1=price,  x2=bar_index + 1,  y2=price,  color=color.blue, style=line.style_dashed)
            

// Add labels for predictions
if show_predictions and array.size(recent_prices) > 0
    label.new(x=bar_index,  y=array.get(recent_prices, array.size(recent_prices) - 1), text="Predicted: " + str.tostring(array.get(recent_prices, array.size(recent_prices) - 1)), color=color.blue, style=label.style_label_down)
        