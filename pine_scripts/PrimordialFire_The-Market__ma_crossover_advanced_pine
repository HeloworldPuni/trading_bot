//@version=5
indicator(\"Advanced Moving Average Crossover with Alerts\", shorttitle=\"MA Cross Pro\", overlay=true)

// === INPUT PARAMETERS ===
// Moving Average Settings
fast_length = input.int(10, title=\"Fast MA Length\", minval=1, maxval=200)
slow_length = input.int(20, title=\"Slow MA Length\", minval=1, maxval=200)
ma_type = input.string(\"EMA\", title=\"MA Type\", options=[\"SMA\", \"EMA\", \"WMA\", \"VWMA\", \"RMA\"])

// Signal Filters
use_volume_filter = input.bool(true, title=\"Use Volume Filter\")
volume_threshold = input.float(1.2, title=\"Volume Threshold (x Average)\", minval=0.1, maxval=5.0)
use_trend_filter = input.bool(true, title=\"Use Trend Filter\")
trend_length = input.int(50, title=\"Trend Filter Length\", minval=10, maxval=200)

// Risk Management
use_atr_stops = input.bool(true, title=\"Use ATR-Based Stops\")
atr_length = input.int(14, title=\"ATR Length\", minval=1, maxval=50)
atr_multiplier = input.float(2.0, title=\"ATR Stop Multiplier\", minval=0.1, maxval=10.0)

// Alert Settings
enable_alerts = input.bool(true, title=\"Enable Alerts\")

// === MOVING AVERAGE CALCULATION ===
get_ma(source, length, ma_type) =>
    switch ma_type
        \"SMA\" => ta.sma(source, length)
        \"EMA\" => ta.ema(source, length)
        \"WMA\" => ta.wma(source, length)
        \"VWMA\" => ta.vwma(source, length)
        \"RMA\" => ta.rma(source, length)

// Calculate MAs
fast_ma = get_ma(close, fast_length, ma_type)
slow_ma = get_ma(close, slow_length, ma_type)
trend_ma = get_ma(close, trend_length, ma_type)

// === SIGNAL GENERATION ===
// Basic crossover signals
bullish_cross = ta.crossover(fast_ma, slow_ma)
bearish_cross = ta.crossunder(fast_ma, slow_ma)

// Volume filter
vol_sma = ta.sma(volume, 20)
high_volume = volume > vol_sma * volume_threshold

// Trend filter
uptrend = close > trend_ma
downtrend = close < trend_ma

// RSI filter for confluence
rsi = ta.rsi(close, 14)
rsi_bullish = rsi > 30 and rsi < 70
rsi_bearish = rsi > 30 and rsi < 70

// Combined signals
buy_signal = bullish_cross and (not use_volume_filter or high_volume) and (not use_trend_filter or uptrend) and rsi_bullish
sell_signal = bearish_cross and (not use_volume_filter or high_volume) and (not use_trend_filter or downtrend) and rsi_bearish

// === ATR-BASED STOP LOSSES ===
atr = ta.atr(atr_length)
atr_stop_long = close - atr * atr_multiplier
atr_stop_short = close + atr * atr_multiplier

// Track stops
var float long_stop = na
var float short_stop = na

if buy_signal
    long_stop := use_atr_stops ? atr_stop_long : close * 0.98  // 2% stop if not using ATR
    short_stop := na

if sell_signal
    short_stop := use_atr_stops ? atr_stop_short : close * 1.02  // 2% stop if not using ATR
    long_stop := na

// Update trailing stops
if not na(long_stop)
    long_stop := math.max(long_stop, atr_stop_long)

if not na(short_stop)
    short_stop := math.min(short_stop, atr_stop_short)

// === PLOTTING ===
// Moving averages
plot(fast_ma, color=color.new(color.orange, 0), linewidth=2, title=\"Fast MA\")
plot(slow_ma, color=color.new(color.blue, 0), linewidth=2, title=\"Slow MA\")
plot(trend_ma, color=color.new(color.gray, 50), linewidth=1, title=\"Trend MA\")

// Signals
plotshape(buy_signal, title=\"Buy Signal\", location=location.belowbar, color=color.green, style=shape.labelup, text=\"BUY\", size=size.small)
plotshape(sell_signal, title=\"Sell Signal\", location=location.abovebar, color=color.red, style=shape.labeldown, text=\"SELL\", size=size.small)

// Stop levels
plot(long_stop, color=color.new(color.red, 0), style=plot.style_stepline, linewidth=2, title=\"Long Stop\")
plot(short_stop, color=color.new(color.red, 0), style=plot.style_stepline, linewidth=2, title=\"Short Stop\")

// Background coloring for trend
bgcolor(use_trend_filter ? (uptrend ? color.new(color.green, 95) : color.new(color.red, 95)) : na, title=\"Trend Background\")

// === TABLE FOR INFORMATION ===
var table info_table = table.new(position.top_right, 2, 8, bgcolor=color.white, border_width=1)

if barstate.islast
    table.cell(info_table, 0, 0, \"Parameter\", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 0, \"Value\", text_color=color.black, bgcolor=color.gray)
    
    table.cell(info_table, 0, 1, \"Fast MA\", text_color=color.black)
    table.cell(info_table, 1, 1, str.tostring(fast_length) + \" \" + ma_type, text_color=color.black)
    
    table.cell(info_table, 0, 2, \"Slow MA\", text_color=color.black)
    table.cell(info_table, 1, 2, str.tostring(slow_length) + \" \" + ma_type, text_color=color.black)
    
    table.cell(info_table, 0, 3, \"Fast MA Value\", text_color=color.black)
    table.cell(info_table, 1, 3, str.tostring(fast_ma, \"#.##\"), text_color=color.black)
    
    table.cell(info_table, 0, 4, \"Slow MA Value\", text_color=color.black)
    table.cell(info_table, 1, 4, str.tostring(slow_ma, \"#.##\"), text_color=color.black)
    
    table.cell(info_table, 0, 5, \"Current RSI\", text_color=color.black)
    table.cell(info_table, 1, 5, str.tostring(rsi, \"#.##\"), text_color=color.black)
    
    table.cell(info_table, 0, 6, \"Volume vs Avg\", text_color=color.black)
    table.cell(info_table, 1, 6, str.tostring(volume/vol_sma, \"#.##\") + \"x\", text_color=color.black)
    
    table.cell(info_table, 0, 7, \"ATR Stop Dist\", text_color=color.black)
    table.cell(info_table, 1, 7, str.tostring(atr * atr_multiplier, \"#.##\"), text_color=color.black)

// === ALERTS ===
if enable_alerts
    alertcondition(buy_signal, title=\"MA Cross Buy Signal\", message=\"{{ticker}} - Moving Average Crossover BUY signal at {{close}}. Fast MA: {{plot(\\\"fast_ma\\\")}}, Slow MA: {{plot(\\\"slow_ma\\\")}}\")
    alertcondition(sell_signal, title=\"MA Cross Sell Signal\", message=\"{{ticker}} - Moving Average Crossover SELL signal at {{close}}. Fast MA: {{plot(\\\"fast_ma\\\")}}, Slow MA: {{plot(\\\"slow_ma\\\")}}\")

// === NOTES ===
// This Pine Script provides:
// 1. Multiple MA types (SMA, EMA, WMA, VWMA, RMA)
// 2. Volume confirmation filter
// 3. Trend filter using longer MA
// 4. RSI confluence filter
// 5. ATR-based dynamic stop losses
// 6. Visual signals and information table
// 7. Customizable alerts
// 8. Background coloring for trend direction

// Usage Instructions:
// 1. Add this script to your TradingView chart
// 2. Configure the MA lengths and type according to your strategy
// 3. Enable/disable filters based on your preference
// 4. Set up alerts for buy/sell signals
// 5. Use the ATR stops for risk management

// Strategy Logic:
// - BUY when fast MA crosses above slow MA with filters
// - SELL when fast MA crosses below slow MA with filters  
// - Filters include volume, trend direction, and RSI
// - Stop losses are dynamically calculated using ATR