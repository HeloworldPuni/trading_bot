// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© EmreKb

//@version=5
indicator(title="Market Structure Break & Order Block",shorttitle="MSB-OB",overlay=true,max_bars_back=4900,max_lines_count=500,max_boxes_count=500,max_labels_count=500)

settings = "Settings"
zigzag_len = input.int(9, "ZigZag Length", group=settings)
show_zigzag = input.bool(true, "Show Zigzag", group=settings)
fib_factor = input.float(0.33, "Fib Factor for breakout confirmation", 0, 1, 0.01, group=settings)

text_size = input.string(size.tiny, "Text Size", [size.tiny, size.small, size.normal, size.large, size.huge], group=settings)

delete_boxes = input.bool(true, "Delete Old/Broken Boxes", group=settings)

// Pending Order Alert Settings
order_alert_settings = "Pending Order Alert Settings"
show_order_alerts = input.bool(true, "Show Pending Order Alerts", group=order_alert_settings)
long_label_text = input.string("LONG", "Long Order Label Text", group=order_alert_settings)
short_label_text = input.string("SHORT", "Short Order Label Text", group=order_alert_settings)
alert_offset = input.int(5, "Alert Marker Offset (Bars)", minval=0, group=order_alert_settings)
enable_alerts = input.bool(true, "Enable Alert Messages", group=order_alert_settings)

bu_ob_inline_color = "Bu-OB Colors"
be_ob_inline_color = "Be-OB Colors"
bu_bb_inline_color = "Bu-BB Colors"
be_bb_inline_color = "Be-BB Colors"

bu_ob_display_settings = "Bu-OB Display Settings"
bu_ob_color = input.color(color.new(color.green, 70), "Color", group=bu_ob_display_settings, inline=bu_ob_inline_color)
bu_ob_border_color = input.color(color.green, "Border Color", group=bu_ob_display_settings, inline=bu_ob_inline_color)
bu_ob_text_color = input.color(color.green, "Text Color", group=bu_ob_display_settings, inline=bu_ob_inline_color)

be_ob_display_settings = "Be-OB Display Settings"
be_ob_color = input.color(color.new(color.red, 70), "Color", group=be_ob_display_settings, inline=be_ob_inline_color)
be_ob_border_color = input.color(color.red, "Border Color", group=be_ob_display_settings, inline=be_ob_inline_color)
be_ob_text_color = input.color(color.red, "Text Color", group=be_ob_display_settings, inline=be_ob_inline_color)

bu_bb_display_settings = "Bu-BB & Bu-MB Display Settings"
bu_bb_color = input.color(color.new(color.green, 70), "Color", group=bu_bb_display_settings, inline=bu_bb_inline_color)
bu_bb_border_color = input.color(color.green, "Border Color", group=bu_bb_display_settings, inline=bu_bb_inline_color)
bu_bb_text_color = input.color(color.green, "Text Color", group=bu_bb_display_settings, inline=bu_bb_inline_color)

be_bb_display_settings = "Be-BB & Be-MB Display Settings"
be_bb_color = input.color(color.new(color.red, 70), "Color", group=be_bb_display_settings, inline=be_bb_inline_color)
be_bb_border_color = input.color(color.red, "Border Color", group=be_bb_display_settings, inline=be_bb_inline_color)
be_bb_text_color = input.color(color.red, "Text Color", group=be_bb_display_settings, inline=be_bb_inline_color)

// Pending Order Alert Colors
order_alert_inline_color = "Pending Order Alert Colors"
long_alert_color = input.color(color.new(color.green, 0), "Long Alert Color", group=order_alert_settings, inline=order_alert_inline_color)
short_alert_color = input.color(color.new(color.red, 0), "Short Alert Color", group=order_alert_settings, inline=order_alert_inline_color)

var float[] high_points_arr = array.new_float(5)
var int[] high_index_arr = array.new_int(5)
var float[] low_points_arr = array.new_float(5)
var int[] low_index_arr = array.new_int(5)

var box[] bu_ob_boxes = array.new_box(5)
var box[] be_ob_boxes = array.new_box(5)
var box[] bu_bb_boxes = array.new_box(5)
var box[] be_bb_boxes = array.new_box(5)

// Add variable to track alert status
var bool last_alert_bullish = na
var bool last_alert_bearish = na

to_up = high >= ta.highest(zigzag_len)
to_down = low <= ta.lowest(zigzag_len)

trend = 1
trend := nz(trend[1], 1)
trend := trend == 1 and to_down ? -1 : trend == -1 and to_up ? 1 : trend

last_trend_up_since = ta.barssince(to_up[1])
low_val = ta.lowest(nz(last_trend_up_since > 0 ? last_trend_up_since : 1, 1))
low_index = bar_index - ta.barssince(low_val == low)

last_trend_down_since = ta.barssince(to_down[1])
high_val = ta.highest(nz(last_trend_down_since > 0 ? last_trend_down_since : 1, 1))
high_index = bar_index - ta.barssince(high_val == high)

if ta.change(trend) != 0
    if trend == 1
        array.push(low_points_arr, low_val)
        array.push(low_index_arr, low_index)
    if trend == -1
        array.push(high_points_arr, high_val)
        array.push(high_index_arr, high_index)

f_get_high(ind) =>
    [array.get(high_points_arr, array.size(high_points_arr) - 1 - ind), array.get(high_index_arr, array.size(high_index_arr) - 1 - ind)]

f_get_low(ind) =>
    [array.get(low_points_arr, array.size(low_points_arr) - 1 - ind), array.get(low_index_arr, array.size(low_index_arr) - 1 - ind)]

f_delete_box(box_arr) =>
    if delete_boxes
        box.delete(array.shift(box_arr))
    else
        array.shift(box_arr)
    0

// simplify the marker function: no global assignments or alerts here
f_create_pending_order_marker(is_bullish, price_level, bar_idx) =>
    if show_order_alerts
        label_style := is_bullish ? label.style_label_up   : label.style_label_down
        label_color := is_bullish ? long_alert_color       : short_alert_color
        label_text  := is_bullish ? long_label_text        : short_label_text
        label_yloc  := is_bullish ? label.yloc_belowbar    : label.yloc_abovebar
        label.new(bar_idx, price_level, label_text,
                  color=label_color,
                  style=label_style,
                  textcolor=color.white,
                  size=text_size,
                  yloc=label_yloc)

[h0, h0i] = f_get_high(0)
[h1, h1i] = f_get_high(1)

[l0, l0i] = f_get_low(0)
[l1, l1i] = f_get_low(1)

if ta.change(trend) != 0 and array.size(high_points_arr) >= 2 and array.size(low_points_arr) >= 2
    // bullish structure break
    if trend == 1 and l0 < l1
        f_create_pending_order_marker(true, h1, bar_index + alert_offset)
        if enable_alerts and not last_alert_bullish
            alert("Place pending BUY order at " + str.tostring(h1), alert.freq_once_per_bar)
        last_alert_bullish := true
        last_alert_bearish := false

    // bearish structure break
    if trend == -1 and h0 > h1
        f_create_pending_order_marker(false, l1, bar_index + alert_offset)
        if enable_alerts and not last_alert_bearish
            alert("Place pending SELL order at " + str.tostring(l1), alert.freq_once_per_bar)
        last_alert_bullish := false
        last_alert_bearish := true

if ta.change(trend) != 0 and show_zigzag
    if trend == 1
        // Draw zigzag line for bullish trend change
        line.new(l0i, l0, bar_index, low, color=bu_bb_border_color, width=1)
    else if trend == -1
        // Draw zigzag line for bearish trend change
        line.new(h0i, h0, bar_index, high, color=be_bb_border_color, width=1)