//@version=6
// ===== Ê¶ÇË¶Å ====================================================================== // Summary
// Êà¶Áï•Âêç: OrderManager // Strategy Name: OrderManager
// ÁõÆÁöÑ: Ë§áÊï∞„ÅÆ„Ç®„É≥„Éà„É™„Éº„Éª„Ç®„Ç∞„Ç∏„ÉÉ„ÉàÊñπÊ≥ï„Å®„ÄÅ„É™„Çπ„ÇØÁÆ°ÁêÜÊ©üËÉΩ„ÇíÂÇô„Åà„ÅüÂèñÂºïÊà¶Áï• // Purpose: Trading strategy with multiple entry/exit methods and risk management functions

// ===== Âü∫Êú¨Ë®≠ÂÆö ==================================================================== // Basic Settings
systemName = 'OrderManager'
initialCapital = 10000
initialPositionSize = 100.0
initialCommissionRate = 0.06
maxPyramidingLevels = 1

strategy(title=systemName,
         shorttitle=systemName, 
         overlay=true, 
         pyramiding=maxPyramidingLevels, 
         initial_capital = initialCapital, 
         default_qty_type=strategy.percent_of_equity, 
         default_qty_value=initialPositionSize, 
         commission_type=strategy.commission.percent, 
         commission_value=initialCommissionRate, 
         precision=6, 
         max_lines_count=500, 
         max_labels_count=500
         )

// ===== 1. Ë®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ =========================================================== // Settings Section

// ----- „Çπ„Éà„ÉÉ„Éó„É≠„ÇπË®≠ÂÆö ----- // Stop Loss Settings
stopLossType = input.string(title='‚ùåStopLoss Type', defval='ATR', options=['None', 'Percent', 'ATR', 'ATR Trailing'], inline = "stopType", group = "StopLoss")

// „Éë„Éº„Çª„É≥„Éà„Çπ„Éà„ÉÉ„Éó // Percent Stop
stopLossPercentage = input.float(title=' Stop loss(%)', minval=0.0, step=0.1, defval=1.8, inline ="LOSS", group = "StopLoss") * 0.01

// ATR„Çπ„Éà„ÉÉ„Éó // ATR Stop
atrPeriodForStopLoss = input.int(title='ATR Length', defval=14, inline ="ATR", group = "StopLoss")
atrMultiplierForStopLoss = input.float(defval=2.0, title='ATR Mult', step=0.10, inline ="ATR", group = "StopLoss")

// ATR„Éà„É¨„Éº„É™„É≥„Ç∞„Çπ„Éà„ÉÉ„Éó // ATR Trailing Stop
atrPeriodForTrailingStop = input.int(14, minval=1,title='Trailing Length', inline="inputsATR", group = "StopLoss")
atrMultiplierForTrailingStop = input.float(1.5,title='Trailing Mult', step = 0.1, inline="inputsATR", group = "StopLoss")

// „Çπ„Éà„ÉÉ„Éó„É≠„ÇπËøΩÂä†Ë®≠ÂÆö // Additional Stop Loss Settings
requireCloseBelowStopLoss = input.bool(false, "Require Close Below Stop Loss", inline = "requireCloseBelowStop", group = "StopLoss")
emergencyStopThreshold = input.float(0.3, step = 0.1, minval=0.0, title = "Emergency Stop Threshold (%)", group = "StopLoss") * 0.01

// ----- Âà©Á¢∫Ë®≠ÂÆö ----- // Take Profit Settings
takeProfitStrategy = input.string(title='‚úÖProfit Type', defval='RR', options=['None', 'Percent', 'RR','ATR'], inline = "takeProfitType", group = "TakeProfit")

// „Éë„Éº„Çª„É≥„ÉàÂà©Á¢∫ // Percent Take Profit
longTakeProfitPercentage = input.float(title='TP%(long)', minval=0.0, step=0.1, defval=1.5, inline = "TP", group = "TakeProfit") * 0.01
shortTakeProfitPercentage = input.float(title='TP%(short)', minval=0.0, step=0.1, defval=1.5, inline = "TP", group = "TakeProfit") * 0.01

// „É™„Çπ„ÇØ„É™„ÉØ„Éº„ÉâÂà©Á¢∫ // Risk-Reward Take Profit
longRiskRewardRatio = input.float(title="RR 1:(long", step=0.1 , defval=1.5, minval = 0, inline = "RR", group = "TakeProfit")
shortRiskRewardRatio = input.float(title="RR 1:(short)", step=0.1 , defval=1.5, minval = 0,inline = "RR", group = "TakeProfit")

// ATRÂà©Á¢∫ // ATR Take Profit
atrPeriodForTakeProfit = input.int(defval = 14, title = 'ATR Length', minval = 1, inline = 'Take Profit ATR Multiplier', group = "TakeProfit")
longAtrMultiplierForTakeProfit = input.float(defval = 2.0, title = 'L_Mult', minval = 0.1, step = 0.1, inline = 'Take Profit ATR Multiplier', group = "TakeProfit")
shortAtrMultiplierForTakeProfit = input.float(defval = 2.0, title = 'S_Mult', minval = 0.1, step = 0.1, inline = 'Take Profit ATR Multiplier', group = "TakeProfit")

// ----- „Éù„Ç∏„Ç∑„Éß„É≥ÁÆ°ÁêÜ ----- // Position Management
closeOnOpposite = input.bool(true, "Close on Opposite Signal", group = "Position Management")
closeStop = input.bool(true, "Use Emergency Stop Loss", group = "Position Management") 

// ----- „Éà„É¨„Éº„Éâ„Éï„Ç£„É´„Çø„Éº ----- // Trade Filters
enableLongStrategy = input.bool(true, "Enable Long Strategy", group = "Trade Filters")
enableShortStrategy = input.bool(true, "Enable Short Strategy", group = "Trade Filters")

// ----- „Ç¢„É©„Éº„Éà„É°„ÉÉ„Çª„Éº„Ç∏ ----- // Alert Messages
Alert_OpenLong = "Long Take Profit Hit"
Alert_OpenShort = "Short Take Profit Hit"
Alert_LongTP = "Long Take Profit"
Alert_ShortTP = "Short Take Profit"

// ----- „Åù„ÅÆ‰ªñË®≠ÂÆö ----- // Other Settings
mainStrategy = input.bool(true,'üü• üü• üü•  Main Strategy Settings üü• üü• üü• ',inline = "mainSettings")


// ===== 2. „É°„Ç§„É≥„É≠„Ç∏„ÉÉ„ÇØ„Çª„ÇØ„Ç∑„Éß„É≥ =================================================== // Main Logic Section

// ----- „Ç®„É≥„Éà„É™„Éº„Ç∑„Ç∞„Éä„É´ ----- // Entry Signals
isBullishSignal = ta.crossover(close, ta.sma(close, 30))    // Ë≤∑„ÅÑ„Ç∑„Ç∞„Éä„É´: 30Êó•SMA„Çí‰∏äÊäú„Åë„Åü„Å®„Åç // Buy signal: When price crosses above 30-day SMA
isBearishSignal = ta.crossunder(close, ta.sma(close, 200))  // Â£≤„Çä„Ç∑„Ç∞„Éä„É´: 200Êó•SMA„Çí‰∏ãÊäú„Åë„Åü„Å®„Åç // Sell signal: When price crosses below 200-day SMA

// „Ç®„Ç∞„Ç∏„ÉÉ„Éà„Éï„É©„Ç∞ // Exit Flags
shouldExitLongPosition = false  // „É¶„Éº„Ç∂„Éº„Åå„Ç´„Çπ„Çø„É†„É≠„Ç∏„ÉÉ„ÇØ„ÅßË®≠ÂÆöÂèØËÉΩ // Can be set by user with custom logic
shouldExitShortPosition = false // „É¶„Éº„Ç∂„Éº„Åå„Ç´„Çπ„Çø„É†„É≠„Ç∏„ÉÉ„ÇØ„ÅßË®≠ÂÆöÂèØËÉΩ // Can be set by user with custom logic

// ----- „Éù„Ç∏„Ç∑„Éß„É≥ÁÆ°ÁêÜ ----- // Position Management
// Êñ∞Ë¶è„Ç®„É≥„Éà„É™„ÉºÊù°‰ª∂ // New Entry Conditions
isValidLongEntry = isBullishSignal and not (strategy.opentrades.size(strategy.opentrades - 1) > 0)
isValidShortEntry = isBearishSignal and not (strategy.opentrades.size(strategy.opentrades - 1) < 0)

// „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éù„Ç∏„Ç∑„Éß„É≥Á¢∫Ë™ç // Active Position Confirmation
isLongPositionActive = isValidLongEntry or strategy.opentrades.size(strategy.opentrades - 1) > 0 and not shouldExitLongPosition
isShortPositionActive = isValidShortEntry or strategy.opentrades.size(strategy.opentrades - 1) < 0 and not shouldExitShortPosition

// „Éù„Ç∏„Ç∑„Éß„É≥ÂÜçÁ¢∫Ë™ç // Position Reconfirmation
isValidLongPosition = isBullishSignal and not (strategy.opentrades.size(strategy.opentrades - 1) > 0)
isValidShortPosition = isBearishSignal and not (strategy.opentrades.size(strategy.opentrades - 1) < 0)

// ----- ATRË®àÁÆó ----- // ATR Calculation
// „Ç®„É≥„Éà„É™„ÉºÊôÇ„ÅÆATRÂÄ§ // ATR Value at Entry
initialAtrValue = ta.valuewhen(isValidLongPosition or isValidShortPosition, ta.atr(atrPeriodForStopLoss), 0)
initialAtrValueForTakeProfit = ta.valuewhen(isValidLongPosition or isValidShortPosition, ta.atr(atrPeriodForTakeProfit), 0)
xAtr = ta.atr(atrPeriodForTrailingStop)

// ----- „Çπ„Éà„ÉÉ„Éó„É≠„ÇπË®≠ÂÆö ----- // Stop Loss Settings
useStopLoss = stopLossType != 'None'
useSlPercent = stopLossType == 'Percent'
useSlAtr = stopLossType == 'ATR'
useSlAtrTrailing = stopLossType == "ATR Trailing"

// „Éë„Éº„Çª„É≥„Éà„Çπ„Éà„ÉÉ„Éó„É≠„ÇπË®àÁÆó // Percent Stop Loss Calculation
longStopPricePercent = strategy.position_avg_price * (1 - stopLossPercentage)
shortPerStopPrice = strategy.position_avg_price * (1 + stopLossPercentage)

// ATR„Çπ„Éà„ÉÉ„Éó„É≠„ÇπË®àÁÆó // ATR Stop Loss Calculation
xAtrLongStop = strategy.position_avg_price - initialAtrValue * atrMultiplierForStopLoss
xAtrShortStop = strategy.position_avg_price + initialAtrValue * atrMultiplierForStopLoss

// ATR„Éà„É¨„Éº„É™„É≥„Ç∞„Çπ„Éà„ÉÉ„ÉóË®àÁÆó // ATR Trailing Stop Calculation
float atrTrailingStopPrice = na
atrTrailingStopOffset = atrMultiplierForTrailingStop * xAtr

// „Éà„É¨„Éº„É™„É≥„Ç∞„Çπ„Éà„ÉÉ„Éó„É≠„Ç∏„ÉÉ„ÇØÔºà„É≠„É≥„Ç∞„Éª„Ç∑„Éß„Éº„ÉàÂÖ±ÈÄöÂá¶ÁêÜ„ÅÆÊï¥ÁêÜÔºâ // Trailing Stop Logic (Common processing for long/short)
atrTrailingStopCondition = close > nz(atrTrailingStopPrice[1], 0) ? ta.vwap(close) - atrTrailingStopOffset : ta.vwap(close) + atrTrailingStopOffset

atrTrailingStopCalculation = close < nz(atrTrailingStopPrice[1], 0) and close[1] < nz(atrTrailingStopPrice[1], 0) ? math.min(nz(atrTrailingStopPrice[1]), ta.vwap(close) + atrTrailingStopOffset) : atrTrailingStopCondition

atrTrailingStopPrice := close > nz(atrTrailingStopPrice[1], 0) and close[1] > nz(atrTrailingStopPrice[1], 0) ? math.max(nz(atrTrailingStopPrice[1]), ta.vwap(close) - atrTrailingStopOffset) : atrTrailingStopCalculation

xAtrTrailingStop = atrTrailingStopPrice

// ÊúÄÁµÇ„Çπ„Éà„ÉÉ„Éó„É≠„ÇπÂÄ§„ÅÆÊ±∫ÂÆö // Determining Final Stop Loss Value
float finalSlLong = 0.0
float finalSlShort = 0.0

// „Çø„Ç§„Éó„Å´Âü∫„Å•„ÅÑ„Åü„Çπ„Éà„ÉÉ„Éó„É≠„Çπ„ÅÆÊ±∫ÂÆö // Determine stop loss based on type
finalSlLong := switch
    useSlPercent => longStopPricePercent
    useSlAtr => xAtrLongStop
    useSlAtrTrailing => xAtrTrailingStop
    => na

finalSlShort := switch
    useSlPercent => shortPerStopPrice
    useSlAtr => xAtrShortStop
    useSlAtrTrailing => xAtrTrailingStop
    => na

// ÁèæÂú®„ÅÆ„Çπ„Éà„ÉÉ„Éó„É≠„Çπ„É¨„Éô„É´ // Current Stop Loss Level
currentLongStopLossLevel = useStopLoss ? finalSlLong : na
currentShortStopLossLevel = useStopLoss ? finalSlShort : na

// ‰ΩøÁî®„Çπ„Éà„ÉÉ„Éó„É≠„Çπ„É¨„Éô„É´Ôºàstrategy.exitÁî®Ôºâ // Stop Loss Level for strategy.exit
float floatStopLossLong = currentLongStopLossLevel
float floatStopLossShort = currentShortStopLossLevel

// Á∑äÊÄ•„Çπ„Éà„ÉÉ„Éó„É≠„ÇπË®≠ÂÆö // Emergency Stop Loss Setting
longEmergencyStopLevel = finalSlLong * (1 - emergencyStopThreshold)
shortEmergencyStopLevel = finalSlShort * (1 + emergencyStopThreshold)

// ----- Âà©Á¢∫Ë®≠ÂÆö ----- // Take Profit Settings
useTp = takeProfitStrategy != 'None'

// „É™„Çπ„ÇØ„É™„ÉØ„Éº„ÉâÊØî„ÅÆ„Åü„ÇÅ„ÅÆ„Çπ„Éà„ÉÉ„Éó„É≠„ÇπË∑ùÈõ¢Ë®àÁÆó // Stop Loss Distance Calculation for Risk-Reward Ratio
longTrailingStopDistance = strategy.position_avg_price - floatStopLossLong 
shortTrailingStopDistance = floatStopLossShort - strategy.position_avg_price 

// Âà©Á¢∫„Çø„Ç§„Éó„Å´Âü∫„Å•„ÅÑ„ÅüË®àÁÆó // Calculation Based on Take Profit Type
tpLong = switch takeProfitStrategy
    "Percent" => strategy.position_avg_price * (1 + longTakeProfitPercentage)
    "RR" => strategy.position_avg_price + (longTrailingStopDistance * longRiskRewardRatio)
    "ATR" => close + longAtrMultiplierForTakeProfit * initialAtrValueForTakeProfit
    => na

tpShort = switch takeProfitStrategy
    "Percent" => strategy.position_avg_price * (1 - shortTakeProfitPercentage)
    "RR" => strategy.position_avg_price - (shortTrailingStopDistance * shortRiskRewardRatio)
    "ATR" => close - shortAtrMultiplierForTakeProfit * initialAtrValueForTakeProfit
    => na

// ‰ΩøÁî®Âà©Á¢∫„É¨„Éô„É´ // Take Profit Level to Use
longTakeProfitLevel = useTp ? tpLong : na
shortTakeProfitLevel = useTp ? tpShort : na

// ----- „Éà„É¨„Éº„ÉâÊñπÂêë„Éï„Ç£„É´„Çø„Éº ----- // Trade Direction Filter
isLongTradeAllowed = true  // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÄÅÂÆüÈöõ„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„Å´ÁΩÆ„ÅçÊèõ„ÅàÂèØËÉΩ // Placeholder, can be replaced with actual logic
isShortTradeAllowed = true // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÄÅÂÆüÈöõ„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„Å´ÁΩÆ„ÅçÊèõ„ÅàÂèØËÉΩ // Placeholder, can be replaced with actual logic

// ===== „Éà„É¨„Éº„Éâ„É≠„Ç∏„ÉÉ„ÇØ =================================================== // Trade Logic
// Âà©Á¢∫‰æ°Ê†º„ÅÆË®òÈå≤„Å®Á∂≠ÊåÅ // Recording and Maintaining Take Profit Price
float longTakeProfitPrice = na
longTakeProfitPrice := switch
    isLongPositionActive and isValidLongEntry => tpLong
    isLongPositionActive => nz(longTakeProfitPrice[1], tpLong)
    => na

float shortTakeProfitPrice = na
shortTakeProfitPrice := switch
    isShortPositionActive and isValidShortEntry => tpShort
    isShortPositionActive => nz(shortTakeProfitPrice[1], tpShort)
    => na

// ===== „Éù„Ç∏„Ç∑„Éß„É≥„Çµ„Ç§„Ç∏„É≥„Ç∞ ==================================================== // Position Sizing
useStop = input.bool(false, "üèõÔ∏èOrder Sizing", group="üèõÔ∏èorder sizing")
setRisk = input.string(title="methods", defval="Risk Base", options=["Risk Base", "Leverage", "Technical Algo"], group="üèõÔ∏èorder sizing", inline="risk")
riskValue = input.float(2.0, title="Risk ", inline="risk", group="üèõÔ∏èorder sizing")
_leverage = input.float(1, 'Lev', step=.5, group="üèõÔ∏èorder sizing", inline="risk")

// „Çπ„Éà„ÉÉ„Éó„É≠„ÇπÈ°ç„ÅÆË®àÁÆó // Stop Loss Amount Calculation
stopLossAmount = stopLossType == 'ATR' ? initialAtrValue * atrMultiplierForStopLoss : stopLossType == "ATR Trailing" ? atrMultiplierForTrailingStop * xAtr : na 

// „É™„Çπ„ÇØË®àÁÆó„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞ // Risk Calculation Helper Functions
slPercent = math.abs((1 - (close - stopLossAmount) / close) * 100)
riskAmountInDollars = strategy.equity * riskValue / 100
entryQuantity = math.abs(riskAmountInDollars / slPercent * 100) / close

percent2money(price, percent) =>
    price * percent / 100 * syminfo.pointvalue
    
calcPositionSize(entryPrice, slPercent) =>
    risk = strategy.equity * riskValue / 100   
    risk / percent2money(entryPrice, slPercent)

// ÂãïÁöÑÈÖçÂàÜË®≠ÂÆö // Dynamic Allocation Settings
lowZoneMultiplier = input.float(0.5, "Low", step=0.1, minval=0, maxval=10, group="üèõÔ∏èorder sizing", inline="DA")
midZoneMultiplier = input.float(1, "Mid", step=0.1, minval=0, maxval=10, group="üèõÔ∏èorder sizing", inline="DA")
highZoneMultiplier = input.float(1.5, "High", step=0.1, minval=0, maxval=10, group="üèõÔ∏èorder sizing", inline="DA")
_riskSourceInput = input.string('ATR', 'DA Source', options=['close', 'volume', 'MA 5', 'MA 25', 'MACD', 'volume MA', 'ATR', 'VWAP', 'RSI', 'MFI'], group="üèõÔ∏èorder sizing", inline="DA2")
riskBandwidth = input.float(3.1, "Risk Band", step=0.01, minval=2, group="üèõÔ∏èorder sizing", inline="DA2")

// „É™„Çπ„ÇØ„Éô„Éº„ÇπË®àÁÆó // Risk-Based Calculation
riskSource = switch _riskSourceInput
    "close" => close
    "volume" => volume
    "MA 5" => ta.sma(close, 5)
    "MA 25" => ta.sma(close, 25)
    "MACD" => ta.sma(close, 5) - ta.sma(close, 25)
    "volume MA" => ta.sma(volume, 25)
    "ATR" => ta.rma(ta.tr(true), 14)
    "VWAP" => ta.vwap(close)
    "RSI" => ta.rsi(close, 14)
    "MFI" => ta.mfi(hlc3,  14)
    => close

// „É™„Çπ„ÇØ„Çæ„Éº„É≥„ÅÆË®àÁÆó // Risk Zone Calculation
riskHighest = ta.highest(riskSource, 100)
riskLowest = ta.lowest(riskSource, 100)
riskThird = ((riskHighest - riskLowest) / riskBandwidth)
riskZone1 = riskLowest + riskThird 
riskZone2 = riskHighest - riskThird 

// „É™„Çπ„ÇØ„Çæ„Éº„É≥„Å´Âü∫„Å•„ÅÑ„Åü„Éú„É™„É•„Éº„É†‰πóÊï∞„ÅÆË®≠ÂÆö // Setting Volume Multiplier Based on Risk Zone
var float volumeMultiplier = 1.0

if riskLowest <= riskSource and riskSource <= riskZone1
    volumeMultiplier := lowZoneMultiplier

if riskZone1 < riskSource and riskSource <= riskZone2
    volumeMultiplier := midZoneMultiplier

if riskZone2 < riskSource and riskSource <= riskHighest
    volumeMultiplier := highZoneMultiplier

// „ÉÜ„ÇØ„Éã„Ç´„É´„Ç¢„É´„Ç¥„É™„Ç∫„É†„Å´„Çà„Çã„Ç™„Éº„ÉÄ„Éº„Çµ„Ç§„Ç∫Ë®àÁÆó // Order Size Calculation Using Technical Algorithm
orderSize = (strategy.equity / close)
orderSize := (strategy.equity / close * volumeMultiplier)

// „Çπ„Éà„ÉÉ„Éó„É≠„Çπ„Çø„Ç§„Éó„Å´Âü∫„Å•„ÅÑ„Åü„É™„Çπ„ÇØ„Éù„Ç∏„Ç∑„Éß„É≥„Çµ„Ç§„Ç∫„ÅÆË®àÁÆó // Risk Position Size Calculation Based on Stop Loss Type
calculatedRiskPositionSize = switch stopLossType
    "Percent" => calcPositionSize(close, (stopLossPercentage * 100))
    "ATR" => math.abs(riskAmountInDollars / slPercent * 100) / close
    "ATR Trailing" => math.abs(riskAmountInDollars / slPercent * 100) / close
    => float(na)

// ÈÅ∏Êäû„Åï„Çå„Åü„É™„Çπ„ÇØÊñπÊ≥ï„Å´Âü∫„Å•„Åè„Éù„Ç∏„Ç∑„Éß„É≥„Çµ„Ç§„Ç∫Ë®àÁÆó // Position Size Calculation Based on Selected Risk Method
calculatedPositionSize = switch setRisk
    "Risk Base" => calculatedRiskPositionSize
    "Leverage" => math.min(math.max(.000001, strategy.equity / close * _leverage), 1000000000)
    "Technical Algo" => orderSize
    => float(na)

// ===== „Ç®„É≥„Éà„É™„Éº„É≠„Ç∏„ÉÉ„ÇØ =================================================== // Entry Logic
// „É≠„É≥„Ç∞„Ç®„É≥„Éà„É™„Éº // Long Entry
if isBullishSignal and enableLongStrategy and isLongTradeAllowed 
    positionSize = useStop ? calculatedPositionSize : na
    if useStop
        strategy.entry("Long", strategy.long, qty=positionSize, comment="Long", alert_message="Opening Long")
    else
        strategy.entry("Long", strategy.long, comment="Long", alert_message="Opening Long")
    strategy.exit(id='Long', limit=longTakeProfitLevel, stop=closeStop ? na : currentLongStopLossLevel, comment='Exit Long TP', alert_message=Alert_OpenLong)

// „Ç∑„Éß„Éº„Éà„Ç®„É≥„Éà„É™„Éº // Short Entry
if isBearishSignal and enableShortStrategy and isShortTradeAllowed 
    positionSize = useStop ? calculatedPositionSize : na
    if useStop
        strategy.entry("Short", strategy.short, qty=positionSize, comment="Short", alert_message="Opening Short")
    else
        strategy.entry("Short", strategy.short, comment="Short", alert_message="Opening Short")
    strategy.exit(id='Short', limit=shortTakeProfitLevel, stop=closeStop ? na : currentShortStopLossLevel, comment='Exit Short TP', alert_message=Alert_OpenShort)

// ===== „Ç®„Ç∞„Ç∏„ÉÉ„ÉàÁÆ°ÁêÜ =================================================== // Exit Management
// ÈÄöÂ∏∏„ÅÆ„Ç®„Ç∞„Ç∏„ÉÉ„ÉàÁÆ°ÁêÜ // Normal Exit Management
if strategy.position_size > 0
    strategy.exit(id='Long', limit=longTakeProfitLevel, stop=closeStop ? na : floatStopLossLong, comment='Exit Long TP')
if strategy.position_size < 0
    strategy.exit(id='Short', limit=shortTakeProfitLevel, stop=closeStop ? na : floatStopLossShort, comment='Exit Short TP')

// Êù°‰ª∂„Å´Âü∫„Å•„Åè„Éù„Ç∏„Ç∑„Éß„É≥„ÇØ„É≠„Éº„Ç∫ // Position Close Based on Conditions
// ÂèçÂØæ„Ç∑„Ç∞„Éä„É´„Å´„Çà„Çã„ÇØ„É≠„Éº„Ç∫ // Close on Opposite Signal
if closeOnOpposite and strategy.position_size > 0 and isBearishSignal  
    strategy.close(id='Long', comment='Short Signal\nClose Long')
if closeOnOpposite and strategy.position_size < 0 and isBullishSignal  
    strategy.close(id='Short', comment='Long Signal\nClose Short')

// „Ç´„Çπ„Çø„É†„Ç®„Ç∞„Ç∏„ÉÉ„ÉàÊù°‰ª∂ // Custom Exit Conditions
if strategy.position_size > 0 and shouldExitLongPosition
    strategy.close(id='Long', comment='Custom Close Signal\nClose Long')
if strategy.position_size < 0 and shouldExitShortPosition
    strategy.close(id='Short', comment='Custom Close Signal\nClose Short')

// Á∑äÊÄ•„Çπ„Éà„ÉÉ„Éó„É≠„Çπ // Emergency Stop Loss
if closeStop and strategy.position_size > 0 and close <= longEmergencyStopLevel
    strategy.close(id='Long', comment='Emergency Stop Long')
if closeStop and strategy.position_size < 0 and close >= shortEmergencyStopLevel
    strategy.close(id='Short', comment='Emergency Stop Short')

// ===== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„Çª„ÇØ„Ç∑„Éß„É≥ =================================================== // Utility Section
showTakeProfitStopLossPlots = input.bool(true, title="üìäshow Plot TP / SL", group="üìäDashboard")

// „Çπ„Éà„ÉÉ„Éó„É≠„Çπ„Å®Âà©Á¢∫„É¨„Éô„É´ // Stop Loss and Take Profit Levels
longStopLossLevel = currentLongStopLossLevel
shortStopLossLevel = currentShortStopLossLevel

// „Éó„É≠„ÉÉ„ÉàË®≠ÂÆö // Plot Settings
plotStopLossLong = plot(showTakeProfitStopLossPlots and strategy.position_size > 0 ? longStopLossLevel : na, style=plot.style_linebr, color=color.new(color.red, 0), linewidth=3, title="Long Stop Loss")
plotEmergencyStopLong = plot(closeStop and showTakeProfitStopLossPlots and strategy.position_size > 0 ? longEmergencyStopLevel : na, style=plot.style_linebr, color=color.new(color.orange, 0), linewidth=3, title="Long Emergency Stop")
plotStopLossShort = plot(showTakeProfitStopLossPlots and strategy.position_size < 0 ? shortStopLossLevel : na, style=plot.style_linebr, color=color.new(color.red, 0), linewidth=3, title="Short Stop Loss")
plotEmergencyStopShort = plot(closeStop and showTakeProfitStopLossPlots and strategy.position_size < 0 ? shortEmergencyStopLevel : na, style=plot.style_linebr, color=color.new(color.orange, 0), linewidth=3, title="Short Emergency Stop")
plotTakeProfitLong = plot(showTakeProfitStopLossPlots and strategy.position_size > 0 ? longTakeProfitLevel : na, style=plot.style_linebr, color=color.new(color.green, 0), linewidth=3, title="Long Take Profit")
plotTakeProfitShort = plot(showTakeProfitStopLossPlots and strategy.position_size < 0 ? shortTakeProfitLevel : na, style=plot.style_linebr, color=color.new(color.green, 0), linewidth=3, title="Short Take Profit")
entryPriceLine = plot(showTakeProfitStopLossPlots ? strategy.position_avg_price : na, color=color.new(color.white, 50), style=plot.style_linebr, linewidth=3, title="Entry Price Marker")

// „Ç®„É™„Ç¢Â°ó„Çä„Å§„Å∂„Åó // Area Fill
fill(entryPriceLine, plotStopLossLong, color.new(color.red, 80))
fill(entryPriceLine, plotStopLossShort, color.new(color.red, 80))
fill(entryPriceLine, plotTakeProfitLong, color.new(color.green, 80))
fill(entryPriceLine, plotTakeProfitShort, color.new(color.green, 80))
fill(plotStopLossLong, plotEmergencyStopLong, color.new(color.orange, 80))
fill(plotStopLossShort, plotEmergencyStopShort, color.new(color.orange, 80))