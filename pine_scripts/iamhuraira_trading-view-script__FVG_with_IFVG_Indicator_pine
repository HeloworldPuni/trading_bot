//@version=5
indicator("FVG & IFVG Gap Indicator", overlay=true, max_boxes_count=500, max_lines_count=500)

// ============ GAP TYPE SELECTION ============
showFVG = input.bool(true, "Show FVG (Fair Value Gap)", group="Gap Type")
showIFVG = input.bool(true, "Show IFVG (Inversion Fair Value Gap)", group="Gap Type", tooltip="IFVG shows FVGs that have been filled and then reversed")

// ============ DISPLAY SETTINGS ============
showBullishFVG = input.bool(true, "Show Bullish FVG", group="FVG Display")
showBearishFVG = input.bool(true, "Show Bearish FVG", group="FVG Display")

showBullishIFVG = input.bool(true, "Show Bullish IFVG", group="IFVG Display")
showBearishIFVG = input.bool(true, "Show Bearish IFVG", group="IFVG Display")

boxBars = input.int(10, "Box Width (Bars)", minval=1, maxval=500, group="General Display", tooltip="Width of boxes for FVG and IFVG")
lookbackDays = input.int(7, "Lookback Days", minval=1, maxval=365, group="General Display", tooltip="Number of days to look back for both FVG and IFVG")
ifvgDisplayCount = input.int(5, "IFVG Display Count", minval=1, maxval=100, group="General Display", tooltip="Number of most recent IFVGs to display")
ifvgExtendMode = input.string("Fixed Width", "IFVG Display Mode", options=["Fixed Width", "Extend to Current", "Both"], group="General Display", tooltip="Fixed Width: Shows IFVG for boxBars length only\nExtend to Current: Extends IFVG to current bar\nBoth: Shows fixed box + projection")
removeFilled = input.bool(false, "Remove FVG When Filled", group="Mitigation", tooltip="Remove FVG boxes when price completely fills them")
minGapPips = input.float(0, "Min Gap Size (0=All)", minval=0, group="Filter", tooltip="Minimum gap size to display. Set to 0 to show all gaps.")
atrMulti = input.float(0.25, "ATR Multiplier for IFVG", step=0.25, minval=0, group="Filter", tooltip="Filters IFVGs based on ATR Width")

// ============ COLORS ============
bullishFVGColor = input.color(color.new(color.green, 85), "Bullish FVG", group="FVG Colors")
bearishFVGColor = input.color(color.new(color.red, 85), "Bearish FVG", group="FVG Colors")
bullishIFVGColor = input.color(color.new(#089981, 80), "Bullish IFVG", group="IFVG Colors")
bearishIFVGColor = input.color(color.new(#f23645, 80), "Bearish IFVG", group="IFVG Colors")
midlineColor = input.color(#787b86, "IFVG Midline", group="IFVG Colors")

// ============ CALCULATIONS ============
cutoffTime = time - (lookbackDays * 24 * 60 * 60 * 1000)
isInLookback = time >= cutoffTime

safeBoxBars = math.min(boxBars, 500)

c_top = math.max(open, close)
c_bot = math.min(open, close)

// ============ FVG STORAGE ARRAYS ============
var box[] bullishFVGBoxes = array.new_box()
var float[] bullishFVGTops = array.new_float()
var float[] bullishFVGBottoms = array.new_float()
var int[] bullishFVGTimes = array.new_int()

var box[] bearishFVGBoxes = array.new_box()
var float[] bearishFVGTops = array.new_float()
var float[] bearishFVGBottoms = array.new_float()
var int[] bearishFVGTimes = array.new_int()

// ============ IFVG STORAGE ============
type IFVGType
    int leftTime
    int rightTime
    float top
    float bottom
    float mid
    int dir
    int state
    int inversionTime

// ============ IFVG STORAGE ARRAYS ============
var array<IFVGType> bullFVGTracking = array.new<IFVGType>()
var array<IFVGType> bearFVGTracking = array.new<IFVGType>()
var array<IFVGType> bullInversions = array.new<IFVGType>()
var array<IFVGType> bearInversions = array.new<IFVGType>()

buffer = 100
invis = color.rgb(0, 0, 0, 100)

// ============ FVG DETECTION ============
bullishFVG = false
bullishFVGTop = 0.0
bullishFVGBottom = 0.0

if showFVG and bar_index >= 2 and isInLookback
    if low > high[2] and close[1] > high[2]
        gapSize = low - high[2]
        if minGapPips == 0 or gapSize >= minGapPips
            bullishFVG := true
            bullishFVGTop := low
            bullishFVGBottom := high[2]

bearishFVG = false
bearishFVGTop = 0.0
bearishFVGBottom = 0.0

if showFVG and bar_index >= 2 and isInLookback
    if high < low[2] and close[1] < low[2]
        gapSize = low[2] - high
        if minGapPips == 0 or gapSize >= minGapPips
            bearishFVG := true
            bearishFVGTop := low[2]
            bearishFVGBottom := high

// ============ CREATE FVG BOXES ============
if bullishFVG and showBullishFVG
    bullBox = box.new(bar_index - 2, bullishFVGTop, bar_index - 2 + safeBoxBars, bullishFVGBottom, bgcolor = bullishFVGColor, border_color = color.new(color.green, 50), border_width = 1)
    array.push(bullishFVGBoxes, bullBox)
    array.push(bullishFVGTops, bullishFVGTop)
    array.push(bullishFVGBottoms, bullishFVGBottom)
    array.push(bullishFVGTimes, time)

if bearishFVG and showBearishFVG
    bearBox = box.new(bar_index - 2, bearishFVGTop, bar_index - 2 + safeBoxBars, bearishFVGBottom, bgcolor = bearishFVGColor, border_color = color.new(color.red, 50), border_width = 1)
    array.push(bearishFVGBoxes, bearBox)
    array.push(bearishFVGTops, bearishFVGTop)
    array.push(bearishFVGBottoms, bearishFVGBottom)
    array.push(bearishFVGTimes, time)

// ============ IFVG DETECTION ============
if showIFVG and bar_index >= 2 and isInLookback
    atr = nz(ta.atr(200) * atrMulti, ta.cum(high - low) / (bar_index + 1))
    
    // Calculate right time based on box width
    avgBarTime = time - time[1]
    rightTime = time[1] + (avgBarTime * safeBoxBars)
    
    // Detect Bullish FVG for IFVG tracking
    fvg_up = (low > high[2]) and (close[1] > high[2])
    if fvg_up and math.abs(low - high[2]) > atr
        gapSize = low - high[2]
        if minGapPips == 0 or gapSize >= minGapPips
            if array.size(bullFVGTracking) >= buffer
                array.shift(bullFVGTracking)
            array.push(bullFVGTracking, IFVGType.new(time[1], rightTime, low, high[2], math.avg(low, high[2]), 1, 0, na))
    
    // Detect Bearish FVG for IFVG tracking
    fvg_down = (high < low[2]) and (close[1] < low[2])
    if fvg_down and math.abs(low[2] - high) > atr
        gapSize = low[2] - high
        if minGapPips == 0 or gapSize >= minGapPips
            if array.size(bearFVGTracking) >= buffer
                array.shift(bearFVGTracking)
            array.push(bearFVGTracking, IFVGType.new(time[1], rightTime, low[2], high, math.avg(high, low[2]), -1, 0, na))
    
    // Manage Bullish FVGs - Check if they get filled (bearish inversion)
    if array.size(bullFVGTracking) > 0
        for i = array.size(bullFVGTracking) - 1 to 0
            fvgData = array.get(bullFVGTracking, i)
            
            // If price closes below the FVG bottom (filled)
            if fvgData.dir == 1 and c_bot < fvgData.bottom
                fvgData.inversionTime := time
                if array.size(bearInversions) >= buffer
                    array.shift(bearInversions)
                array.push(bearInversions, array.remove(bullFVGTracking, i))
    
    // Manage Bearish FVGs - Check if they get filled (bullish inversion)
    if array.size(bearFVGTracking) > 0
        for i = array.size(bearFVGTracking) - 1 to 0
            fvgData = array.get(bearFVGTracking, i)
            
            // If price closes above the FVG top (filled)
            if fvgData.dir == -1 and c_top > fvgData.top
                fvgData.inversionTime := time
                if array.size(bullInversions) >= buffer
                    array.shift(bullInversions)
                array.push(bullInversions, array.remove(bearFVGTracking, i))
    
    // Manage Bear Inversions (bullish FVG got filled, now watching for bearish reversal)
    if array.size(bearInversions) > 0
        for i = array.size(bearInversions) - 1 to 0
            inv = array.get(bearInversions, i)
            
            if inv.state == 0 and inv.dir == 1
                inv.state := 1
                inv.dir := -1
            
            // Remove if price breaks above
            if inv.state >= 1 and c_top > inv.top
                array.remove(bearInversions, i)
    
    // Manage Bull Inversions (bearish FVG got filled, now watching for bullish reversal)
    if array.size(bullInversions) > 0
        for i = array.size(bullInversions) - 1 to 0
            inv = array.get(bullInversions, i)
            
            if inv.state == 0 and inv.dir == -1
                inv.state := 1
                inv.dir := 1
            
            // Remove if price breaks below
            if inv.state >= 1 and c_bot < inv.bottom
                array.remove(bullInversions, i)

// ============ IFVG DRAWING STORAGE ============
var box[] ifvgBoxes = array.new_box()
var line[] ifvgLines = array.new_line()

// ============ DRAW IFVGs ============
if barstate.islast and showIFVG
    // Delete all previous IFVG drawings
    if array.size(ifvgBoxes) > 0
        for i = 0 to array.size(ifvgBoxes) - 1
            box.delete(array.get(ifvgBoxes, i))
        array.clear(ifvgBoxes)
    
    if array.size(ifvgLines) > 0
        for i = 0 to array.size(ifvgLines) - 1
            line.delete(array.get(ifvgLines, i))
        array.clear(ifvgLines)
    
    // Draw Bullish IFVGs (bearish FVG that got filled and inverted bullish)
    if showBullishIFVG and array.size(bullInversions) > 0
        lastIndex = array.size(bullInversions) - 1
        for i = 0 to array.size(bullInversions) - 1
            inv = array.get(bullInversions, i)
            
            // Only draw if within lookback period and within display count
            if inv.leftTime >= cutoffTime and i > lastIndex - ifvgDisplayCount
                if ifvgExtendMode == "Fixed Width"
                    // Fixed width mode - just show original + inverted for boxBars length
                    rightEdge = math.min(inv.rightTime, time)
                    
                    // Original bearish FVG (left side - red)
                    array.push(ifvgBoxes, box.new(inv.leftTime, inv.top, inv.inversionTime, inv.bottom, bgcolor = bearishIFVGColor, border_color = invis, xloc = xloc.bar_time))
                    
                    // Inverted bullish section (right side - green, fixed width)
                    array.push(ifvgBoxes, box.new(inv.inversionTime, inv.top, rightEdge, inv.bottom, bgcolor = bullishIFVGColor, border_color = invis, xloc = xloc.bar_time))
                    
                    // Midline
                    array.push(ifvgLines, line.new(inv.leftTime, inv.mid, rightEdge, inv.mid, color = midlineColor, style = line.style_dashed, xloc = xloc.bar_time))
                
                else if ifvgExtendMode == "Extend to Current"
                    // Extend to current bar mode
                    // Original bearish FVG (left side - red)
                    array.push(ifvgBoxes, box.new(inv.leftTime, inv.top, inv.inversionTime, inv.bottom, bgcolor = bearishIFVGColor, border_color = invis, xloc = xloc.bar_time))
                    
                    // Inverted bullish section (extends to current bar - green)
                    array.push(ifvgBoxes, box.new(inv.inversionTime, inv.top, time, inv.bottom, bgcolor = bullishIFVGColor, border_color = invis, xloc = xloc.bar_time))
                    
                    // Midline
                    array.push(ifvgLines, line.new(inv.leftTime, inv.mid, time, inv.mid, color = midlineColor, style = line.style_dashed, xloc = xloc.bar_time))
                
                else // "Both" mode
                    // Original bearish FVG (left side - red)
                    array.push(ifvgBoxes, box.new(inv.leftTime, inv.top, inv.inversionTime, inv.bottom, bgcolor = bearishIFVGColor, border_color = invis, xloc = xloc.bar_time))
                    
                    // Inverted bullish section (middle - green, extends to current bar)
                    array.push(ifvgBoxes, box.new(inv.inversionTime, inv.top, time, inv.bottom, bgcolor = bullishIFVGColor, border_color = invis, xloc = xloc.bar_time))
                    
                    // Future projection (right side - green, uses bar_index)
                    array.push(ifvgBoxes, box.new(bar_index, inv.top, bar_index + safeBoxBars, inv.bottom, bgcolor = bullishIFVGColor, border_color = invis))
                    
                    // Midline extending through all sections
                    array.push(ifvgLines, line.new(inv.leftTime, inv.mid, time, inv.mid, color = midlineColor, style = line.style_dashed, xloc = xloc.bar_time))
                    array.push(ifvgLines, line.new(bar_index, inv.mid, bar_index + safeBoxBars, inv.mid, color = midlineColor, style = line.style_dashed))
    
    // Draw Bearish IFVGs (bullish FVG that got filled and inverted bearish)
    if showBearishIFVG and array.size(bearInversions) > 0
        lastIndex = array.size(bearInversions) - 1
        for i = 0 to array.size(bearInversions) - 1
            inv = array.get(bearInversions, i)
            
            // Only draw if within lookback period and within display count
            if inv.leftTime >= cutoffTime and i > lastIndex - ifvgDisplayCount
                // Original bullish FVG (left side - green)
                array.push(ifvgBoxes, box.new(inv.leftTime, inv.top, inv.inversionTime, inv.bottom, bgcolor = bullishIFVGColor, border_color = invis, xloc = xloc.bar_time))
                
                // Inverted bearish section (middle - red, extends to current bar)
                array.push(ifvgBoxes, box.new(inv.inversionTime, inv.top, time, inv.bottom, bgcolor = bearishIFVGColor, border_color = invis, xloc = xloc.bar_time))
                
                // Future projection (right side - red, uses bar_index)
                array.push(ifvgBoxes, box.new(bar_index, inv.top, bar_index + safeBoxBars, inv.bottom, bgcolor = bearishIFVGColor, border_color = invis))
                
                // Midline extending through all sections
                array.push(ifvgLines, line.new(inv.leftTime, inv.mid, time, inv.mid, color = midlineColor, style = line.style_dashed, xloc = xloc.bar_time))
                array.push(ifvgLines, line.new(bar_index, inv.mid, bar_index + safeBoxBars, inv.mid, color = midlineColor, style = line.style_dashed))

// ============ REMOVE OLD FVGs & IFVGs ============
// Remove old FVGs based on lookback days
if array.size(bullishFVGBoxes) > 0
    for i = array.size(bullishFVGBoxes) - 1 to 0
        fvgTime = array.get(bullishFVGTimes, i)
        if fvgTime < cutoffTime
            box.delete(array.get(bullishFVGBoxes, i))
            array.remove(bullishFVGBoxes, i)
            array.remove(bullishFVGTops, i)
            array.remove(bullishFVGBottoms, i)
            array.remove(bullishFVGTimes, i)

if array.size(bearishFVGBoxes) > 0
    for i = array.size(bearishFVGBoxes) - 1 to 0
        fvgTime = array.get(bearishFVGTimes, i)
        if fvgTime < cutoffTime
            box.delete(array.get(bearishFVGBoxes, i))
            array.remove(bearishFVGBoxes, i)
            array.remove(bearishFVGTops, i)
            array.remove(bearishFVGBottoms, i)
            array.remove(bearishFVGTimes, i)

// Remove old IFVGs based on lookback days
if array.size(bullInversions) > 0
    for i = array.size(bullInversions) - 1 to 0
        inv = array.get(bullInversions, i)
        if inv.leftTime < cutoffTime
            array.remove(bullInversions, i)

if array.size(bearInversions) > 0
    for i = array.size(bearInversions) - 1 to 0
        inv = array.get(bearInversions, i)
        if inv.leftTime < cutoffTime
            array.remove(bearInversions, i)

// ============ REMOVE FILLED FVGs ============
if removeFilled
    if array.size(bullishFVGBoxes) > 0
        for i = array.size(bullishFVGBoxes) - 1 to 0
            bottom = array.get(bullishFVGBottoms, i)
            if close < bottom
                box.delete(array.get(bullishFVGBoxes, i))
                array.remove(bullishFVGBoxes, i)
                array.remove(bullishFVGTops, i)
                array.remove(bullishFVGBottoms, i)
                array.remove(bullishFVGTimes, i)
    
    if array.size(bearishFVGBoxes) > 0
        for i = array.size(bearishFVGBoxes) - 1 to 0
            top = array.get(bearishFVGTops, i)
            if close > top
                box.delete(array.get(bearishFVGBoxes, i))
                array.remove(bearishFVGBoxes, i)
                array.remove(bearishFVGTops, i)
                array.remove(bearishFVGBottoms, i)
                array.remove(bearishFVGTimes, i)