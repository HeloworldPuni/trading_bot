//Base of script:
//@version=5


//

//
indicator(title="Price Action Trading System v0.3 by Kartik with further modifications",overlay = true, shorttitle="CCIPAT v0.3 + PSAR")
//

len = input.int(14, minval=1, title="CCI Length")
lenUpper = input.int(75, minval=1, title="CCI UpLevel")
lenLower = input.int(-75, maxval=-1, title="CCI DownLevel")
bars_on = input.bool(true, title="Color CCI Bars")

src = input.source(close,title="CCI Source") 
lenLo   = input.int(5, minval=2, title="Low Channel Length")
lenHi   = input.int(5, minval=2, title="High Channel Length")
lenMe = input.int(4, minval=1, title="Median Channel Length")
//
fastLength = input.int(12, minval=1,title="MACD Fast Length")
slowLength=input.int(17,minval=1,title="MACD Slow Length")
signalLength=input.int(8,minval=1,title="MACD Signal Length")
//
rsiLen  = input.int(7,minval=2,title="RSI length")
rsiUpper= input.int(70,minval=50,maxval=100,title="RSI Upper limit")
rsiLower= input.int(30,maxval=50,minval=0,title="RSI Lower Limit")
//
filterM = input.bool(true,title="Use MACD confilter filter")
filterR = input.bool(true,title="Use RSI confirm filter")
filterE = input.bool(true,title="Use Trend direction filter")
dCandles= input.int(4,minval=2,title="Direction test Candles")
//
rsiVal = ta.rsi(src,rsiLen)
//
// Calculate MACD and color background
fastMC = ta.ema(src, fastLength)
slowMC = ta.ema(src, slowLength)
macd = fastMC - slowMC
signal = ta.sma(macd, signalLength)
OutputSignal = signal > macd ? 1 : signal < macd ? -1 : 0
bgcolor(OutputSignal>0?color.red: OutputSignal<0?color.green:color.yellow, transp=90)
plot(slowMC,color=color.blue,transp=0,title="Slow EMA trend line", linewidth=2)

// Calculate and draw the Price Action channel 
emaLo = ta.ema(low,lenLo)
emaHi = ta.ema(high,lenHi)
emaMe = ta.ema(hl2,lenMe)
plot(emaLo,title="Low Price Line",style=plot.style_line,color=color.gray,transp=0,linewidth=2)
plot(emaHi,title="High Price Line",style=plot.style_line,color=color.gray,transp=0,linewidth=2)
plot(emaMe,title="Median Price Line",style=plot.style_line,color=color.orange,transp=0,linewidth=2)

// Calculate CCI
cciVal = ta.cci(src, len)

// Calculate CCI indicating continuance of trend.
isup = cciVal > lenUpper
isdown = cciVal < lenLower
barcolor(bars_on ? isup ? color.aqua : isdown ? color.black : na : na )
// Check have alert and use MACD filter
int cciup_alert = na
int ccidn_alert = na
cciup_alert := isup and close>open and (not filterR or rsiVal>rsiUpper) and (not filterM or OutputSignal<0) and (not filterE or (emaMe>slowMC and ta.rising(slowMC,dCandles))) ? na(cciup_alert[1]) ? 1 : cciup_alert[1]+1 : 0
ccidn_alert := isdown and close<open and (not filterR or rsiVal<rsiLower) and (not filterM or OutputSignal>0) and (not filterE or (emaMe<slowMC and ta.falling(slowMC,dCandles))) ? na(ccidn_alert[1]) ? 1 : ccidn_alert[1]+1 : 0

//
plotshape(cciup_alert==1? cciup_alert : na, title="CCIPAT Up Arrow", style=shape.triangleup,location=location.belowbar, color=color.olive, transp=0, size=size.small)
plotshape(ccidn_alert==1? ccidn_alert : na, title="CCIPAT Down Arrow", style=shape.triangledown,location=location.abovebar, color=color.red, transp=0, size=size.small)

// ADX and DI 
// From BeikabuOyaji
// See their work here: https://www.tradingview.com/script/VTPMMOrx-ADX-and-DI/
len1 = input.int(title="Length", defval=14)
th = input.int(title="threshold", defval=20)

TrueRange = math.max(math.max(high-low, math.abs(high-nz(close[1]))), math.abs(low-nz(close[1])))
DirectionalMovementPlus = high-nz(high[1]) > nz(low[1])-low ? math.max(high-nz(high[1]), 0): 0
DirectionalMovementMinus = nz(low[1])-low > high-nz(high[1]) ? math.max(nz(low[1])-low, 0): 0
float SmoothedTrueRange = na
float SmoothedDirectionalMovementPlus = na
float SmoothedDirectionalMovementMinus = na

SmoothedTrueRange := nz(SmoothedTrueRange[1]) - (nz(SmoothedTrueRange[1])/len1) + TrueRange
SmoothedDirectionalMovementPlus := nz(SmoothedDirectionalMovementPlus[1]) - (nz(SmoothedDirectionalMovementPlus[1])/len1) + DirectionalMovementPlus
SmoothedDirectionalMovementMinus := nz(SmoothedDirectionalMovementMinus[1]) - (nz(SmoothedDirectionalMovementMinus[1])/len1) + DirectionalMovementMinus

DIPlus = SmoothedDirectionalMovementPlus / SmoothedTrueRange * 100
DIMinus = SmoothedDirectionalMovementMinus / SmoothedTrueRange * 100
DX = math.abs(DIPlus-DIMinus) / (DIPlus+DIMinus)*100
ADX = ta.sma(DX, len1)

// custom

buy_adx = (DIPlus > DIMinus) and ADX > 20
buy_adx_alert = buy_adx?1:0
sell_adx = (DIMinus > DIPlus) and ADX > 20
sell_adx_alert = sell_adx?1:0

plotshape(buy_adx_alert==1? buy_adx_alert : na, title="ADX Up Arrow", style=shape.cross,location=location.top, color=color.green, transp=0, size=size.tiny)
plotshape(sell_adx_alert==1? sell_adx_alert : na, title="ADX Down Arrow", style=shape.cross,location=location.top, color=color.maroon, transp=0, size=size.tiny)

adx_buy_strong = buy_adx_alert == 1 and (ADX-ADX[1] > 1)
adx_buy_strong_alert = adx_buy_strong?1:0

adx_sell_strong = sell_adx_alert == 1 and (ADX-ADX[1] > 1)
adx_sell_strong_alert = adx_sell_strong?1:0

plotshape(adx_buy_strong_alert==1? adx_buy_strong_alert : na, title="ADX Up Arrow", style=shape.triangleup,location=location.bottom, color=color.green, transp=0, size=size.tiny)
plotshape(adx_sell_strong_alert==1? adx_sell_strong_alert : na, title="ADX Down Arrow", style=shape.triangledown,location=location.bottom, color=color.red, transp=0, size=size.tiny)

// Indicator: WaveTrend Oscillator 
// Originally from Lazybear
// See their work: https://www.tradingview.com/script/2KE8wTuF-Indicator-WaveTrend-Oscillator-WT/

n1 = input.int(10, "Channel Length")
n2 = input.int(21, "Average Length")
obLevel1 = input.int(60, "Over Bought Level 1")
obLevel2 = input.int(53, "Over Bought Level 2")
osLevel1 = input.int(-60, "Over Sold Level 1")
osLevel2 = input.int(-53, "Over Sold Level 2")
 
ap = hlc3 
esa = ta.ema(ap, n1)
d = ta.ema(math.abs(ap - esa), n1)
ci = (ap - esa) / (0.015 * d)
tci = ta.ema(ci, n2)
 
wt1 = tci
wt2 = ta.sma(wt1,4)

buy_wt1 = wt1 < -45 and wt1-wt1[1] > 0.25 and wt2 < -45 and wt2-wt2[1] > 0.25 
sell_wt1 = wt1 > 50 and wt1-wt1[1] < -0.25 and wt2 > 50 and wt2-wt2[1] < -0.25
buy_wt1_alert = buy_wt1?1:0
sell_wt1_alert = sell_wt1?1:0

buy_pot = wt1-wt1[1] > 7 and wt1 < 0
buy_pot_alert = buy_pot?1:0

sell_pot = wt1-wt1[1] < -7 and wt1 > 0
sell_pot_alert = sell_pot?1:0
plotshape(buy_wt1_alert==1? buy_wt1_alert : na, title="WT diamond", style=shape.diamond,location=location.abovebar, color=color.green, transp=0, size=size.small)
plotshape(sell_wt1_alert==1? sell_wt1_alert : na, title="WT sell diamond", style=shape.diamond,location=location.belowbar, color=color.maroon, transp=0, size=size.small)
plotshape(buy_pot_alert==1? buy_pot_alert : na, title="WT buy potential", style=shape.flag,location=location.top, color=color.green, transp=0, size=size.small)
plotshape(sell_pot_alert==1? sell_pot_alert : na, title="WT sell potential", style=shape.flag,location=location.bottom, color=color.red, transp=0, size=size.small)

// generate an alert if required.
alertcondition(cciup_alert==1 or ccidn_alert==1, title="CCIPAT Alert", message="CCIPAT Alert")

//EOF

// Start of PSAR
start = input.float(title="Start", step=0.001, defval=0.02, group = 'PSAR Settings')
increment = input.float(title="Increment", step=0.001, defval=0.02, group = 'PSAR Settings')
maximum = input.float(title="Maximum", step=0.01, defval=0.2, group = 'PSAR Settings')
width = input.int(title="Point Width", minval=1, defval=2, group = 'PSAR Settings')
highlightStartPoints = input.bool(title="Highlight Start Points ?", defval=true, group = 'PSAR Settings')
showLabels = input.bool(title="Show Buy/Sell Labels ?", defval=true, group = 'PSAR Settings')
highlightState = input.bool(title="Highlight State ?", defval=false, group = 'PSAR Settings')


psar = ta.sar(start, increment, maximum)
dir = psar < close ? 1 : -1

psarColor = dir == 1 ? #3388bb : #fdcc02
psarPlot = plot(psar, title="PSAR", style=plot.style_circles, linewidth=width, color=psarColor, transp=0)

var color longColor = color.green
var color shortColor = color.red

buySignal = dir == 1 and dir[1] == -1
plotshape(buySignal and highlightStartPoints ? psar : na, title="Long Start", location=location.absolute, style=shape.circle, size=size.tiny, color=longColor, transp=0)
plotshape(buySignal and showLabels ? psar : na, title="Buy Label", text="Buy", location=location.absolute, style=shape.labelup, size=size.tiny, color=longColor, textcolor=color.white, transp=0)

sellSignal = dir == -1 and dir[1] == 1
plotshape(sellSignal and highlightStartPoints ? psar : na, title="Short Start", location=location.absolute, style=shape.circle, size=size.tiny, color=shortColor, transp=0)
plotshape(sellSignal and showLabels ? psar : na, title="Sell Label", text="Sell", location=location.absolute, style=shape.labeldown, size=size.tiny, color=shortColor, textcolor=color.white, transp=0)

midPricePlot = plot(ohlc4, title="", display=display.none)

fillColor = highlightState ? (dir == 1 ? longColor : shortColor) : na
fill(midPricePlot, psarPlot, title="Trade State Filling", color=fillColor)

changeCond = dir != dir[1]
alertcondition(changeCond, title="Alert: PSAR Direction Change", message="PSAR has changed direction!")
alertcondition(buySignal, title="Alert: PSAR Long", message="PSAR Long")
alertcondition(sellSignal, title="Alert: PSAR Short", message="PSAR Sell")
