//@version=5
strategy("ðŸ“ˆ Fibonacci Strategy XAU/USD (Buy/Sell Inverse)", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// â”€â”€â”€â”€â”€ INPUTS â”€â”€â”€â”€â”€
group_fibo = "ðŸŒ€ Fibonacci Settings"
length = input.int(50, title="Swing Lookback", group=group_fibo)
fib_level1 = input.float(0.618, title="Fibonacci Level 1", group=group_fibo)
fib_level2 = input.float(0.65, title="Fibonacci Level 2", group=group_fibo)
fib_level3 = input.float(0.786, title="Fibonacci Level 3", group=group_fibo)

group_trade = "âš™ï¸ Trade Settings"
sl_points = input.int(100, title="Stop Loss (points)", group=group_trade)
tp_points = input.int(200, title="Take Profit (points)", group=group_trade)

group_trend = "ðŸ“Š Trend Filter"
sma_length = input.int(200, title="SMA Length", group=group_trend)

// â”€â”€â”€â”€â”€ CALCULATIONS â”€â”€â”€â”€â”€
// Identify swing highs/lows
var float swing_high = na
var float swing_low = na

if ta.highestbars(high, length) == 0
    swing_high := high
if ta.lowestbars(low, length) == 0
    swing_low := low

// Fibonacci for Buy (normal: high â†’ low)
fib_buy_1 = swing_high - (swing_high - swing_low) * fib_level1
fib_buy_2 = swing_high - (swing_high - swing_low) * fib_level2
fib_buy_3 = swing_high - (swing_high - swing_low) * fib_level3

// Fibonacci for Sell (inverse: low â†’ high)
fib_sell_1 = swing_low + (swing_high - swing_low) * fib_level1
fib_sell_2 = swing_low + (swing_high - swing_low) * fib_level2
fib_sell_3 = swing_low + (swing_high - swing_low) * fib_level3

// Trend direction
sma = ta.sma(close, sma_length)
in_uptrend = close > sma
in_downtrend = close < sma

// â”€â”€â”€â”€â”€ TRADE CONDITIONS â”€â”€â”€â”€â”€
// Buy (price retraces into buy zone, in uptrend)
buy_signal = close <= fib_buy_1 and close >= fib_buy_3 and in_uptrend

// Sell (price retraces into inverse sell zone, in downtrend)
sell_signal = close >= fib_sell_1 and close <= fib_sell_3 and in_downtrend

// â”€â”€â”€â”€â”€ STRATEGY EXECUTION â”€â”€â”€â”€â”€
if buy_signal
    strategy.entry("ðŸŸ¢ Buy", strategy.long)
    strategy.exit("ðŸŽ¯ TP/SL Buy", from_entry="ðŸŸ¢ Buy",
      stop=close - sl_points * syminfo.mintick,
      limit=close + tp_points * syminfo.mintick)

if sell_signal
    strategy.entry("ðŸ”´ Sell", strategy.short)
    strategy.exit("ðŸŽ¯ TP/SL Sell", from_entry="ðŸ”´ Sell",
      stop=close + sl_points * syminfo.mintick,
      limit=close - tp_points * syminfo.mintick)

// â”€â”€â”€â”€â”€ VISUALS â”€â”€â”€â”€â”€
// Plot Fibonacci levels
plot(fib_buy_1, title="ðŸ”¸ Buy Fibo 0.618", color=color.orange, linewidth=1)
plot(fib_buy_2, title="ðŸ”¸ Buy Fibo 0.65", color=color.yellow, linewidth=1)
plot(fib_buy_3, title="ðŸ”¸ Buy Fibo 0.786", color=color.fuchsia, linewidth=1)

plot(fib_sell_1, title="ðŸ”» Sell Fibo 0.618", color=color.red, linewidth=1)
plot(fib_sell_2, title="ðŸ”» Sell Fibo 0.65", color=color.maroon, linewidth=1)
plot(fib_sell_3, title="ðŸ”» Sell Fibo 0.786", color=color.purple, linewidth=1)

plot(sma, title="ðŸ“ˆ Trend SMA", color=color.blue, linewidth=1)

// Background highlights
bgcolor(buy_signal ? color.new(color.green, 85) : na, title="Buy Signal Background")
bgcolor(sell_signal ? color.new(color.red, 85) : na, title="Sell Signal Background")

// â”€â”€â”€â”€â”€ ALERT CONDITIONS â”€â”€â”€â”€â”€
// Define conditions for real-time alerts
alertcondition(buy_signal, title="ðŸ”” Buy Signal", message="ðŸ“ˆ BUY Signal on XAU/USD!")
alertcondition(sell_signal, title="ðŸ”” Sell Signal", message="ðŸ“‰ SELL Signal on XAU/USD!")

// Optional: create automatic alerts for debugging (if needed)
if buy_signal
    alert("ðŸ“ˆ BUY Signal on XAU/USD!", alert.freq_once_per_bar)

if sell_signal
    alert("ðŸ“‰ SELL Signal on XAU/USD!", alert.freq_once_per_bar)
