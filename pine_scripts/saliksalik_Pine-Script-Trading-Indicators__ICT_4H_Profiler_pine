// This work is licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International
// ICT 4H Candle Profiler & Assistant - MMXM/T-Trades Inspired Strategy
// Â© Senior Pine Script Developer

//@version=5
indicator("ICT 4H Candle Profiler & Assistant", overlay=true, max_boxes_count=500, max_labels_count=100)

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PART 1: SETTINGS & INPUTS
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grpAsset = "â•â•â•â•â•â• ASSET CLASS â•â•â•â•â•â•"
assetMode = input.string("Indices", "Asset Class", options=["Indices", "Forex"], group=grpAsset, 
  tooltip="Indices: S&P500/Nasdaq (4H @ 18,22,02,06,10,14)\nForex: EURUSD/GBPUSD (4H @ 17,21,01,05,09,13)")

grpDisplay = "â•â•â•â•â•â• DISPLAY OPTIONS â•â•â•â•â•â•"
showBoxes = input.bool(true, "Show 4H Candle Boxes", group=grpDisplay)
showDashboard = input.bool(true, "Show Intent Dashboard", group=grpDisplay)
showLabels = input.bool(true, "Show Red Flag Labels", group=grpDisplay)
showSignals = input.bool(true, "Show CISD Entry Signals", group=grpDisplay)
maxBoxes = input.int(50, "Max Boxes on Chart", minval=10, maxval=100, group=grpDisplay)

grpColors = "â•â•â•â•â•â• COLOR SCHEME â•â•â•â•â•â•"
londonColor = input.color(color.new(color.blue, 80), "London Reversal Window", group=grpColors)
nyAmColor = input.color(color.new(color.orange, 80), "NY AM Reversal Window", group=grpColors)
nyPmColor = input.color(color.new(color.purple, 80), "NY PM Expansion Window", group=grpColors)
otherColor = input.color(color.new(color.gray, 90), "Other Candles", group=grpColors)

grpSignals = "â•â•â•â•â•â• SIGNAL SETTINGS â•â•â•â•â•â•"
pivotLength = input.int(5, "Pivot/Fractal Length", minval=3, maxval=20, group=grpSignals, tooltip="Lookback period for swing highs/lows")
cisdBuyColor = input.color(color.new(color.green, 0), "CISD Buy Color", group=grpSignals)
cisdSellColor = input.color(color.new(color.red, 0), "CISD Sell Color", group=grpSignals)

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PART 2: TIME WINDOW LOGIC
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Convert current time to NY time (handle DST dynamically)
nyHour = hour(time, "America/New_York")
nyMinute = minute(time, "America/New_York")

// Define 4H start times based on asset class
var int[] windowStarts = assetMode == "Indices" ? array.from(18, 22, 2, 6, 10, 14) : array.from(17, 21, 1, 5, 9, 13)

// Get current 4H window index and start hour
getCurrentWindow() =>
    int currentWindow = 0
    int startHour = 0
    
    for i = 0 to 5
        windowStart = array.get(windowStarts, i)
        nextWindow = i < 5 ? array.get(windowStarts, i + 1) : array.get(windowStarts, 0)
        
        // Handle wrap around midnight
        inWindow = nextWindow > windowStart ? 
          (nyHour >= windowStart and nyHour < nextWindow) : 
          (nyHour >= windowStart or nyHour < nextWindow)
        
        if inWindow
            currentWindow := i
            startHour := windowStart
            break
    
    [currentWindow, startHour]

[windowIndex, windowStartHour] = getCurrentWindow()

// Determine session type
getSessionType(int idx) =>
    string sessionType = "Other"
    
    if assetMode == "Indices"
        sessionType := switch idx
            2 => "London"  // 02:00-06:00
            3 => "NY AM"   // 06:00-10:00
            4 => "NY PM"   // 10:00-14:00
            => "Other"
    else  // Forex
        sessionType := switch idx
            2 => "London"  // 01:00-05:00
            3 => "NY AM"   // 05:00-09:00
            4 => "NY PM"   // 09:00-13:00
            => "Other"
    
    sessionType

currentSession = getSessionType(windowIndex)

// Get session color
getSessionColor(string session) =>
    color sessionColor = switch session
        "London" => londonColor
        "NY AM" => nyAmColor
        "NY PM" => nyPmColor
        => otherColor
    sessionColor

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PART 3: 4H CANDLE DATA STRUCTURE
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

type Candle4H
    int startTime
    int windowIdx
    float o
    float h
    float l
    float c
    box bx
    string session

var Candle4H currentCandle = na
var array<Candle4H> candles4H = array.new<Candle4H>()

// Check if new 4H window started
isNewWindow = na(currentCandle) or (windowStartHour != windowStartHour[1] and barstate.isconfirmed)

if isNewWindow
    // Save previous candle
    if not na(currentCandle)
        currentCandle.c := close[1]
        array.push(candles4H, currentCandle)
        
        // Cleanup old boxes
        if array.size(candles4H) > maxBoxes
            oldCandle = array.shift(candles4H)
            if not na(oldCandle.bx)
                box.delete(oldCandle.bx)
    
    // Start new candle
    currentCandle := Candle4H.new(time, windowIndex, open, high, low, close, na, currentSession)
else if not na(currentCandle)
    // Update current candle
    currentCandle.h := math.max(currentCandle.h, high)
    currentCandle.l := math.min(currentCandle.l, low)
    currentCandle.c := close

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PART 4: DRAW 4H CANDLE BOXES
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Calculate box coordinates (outside condition for consistency)
windowStartBar = ta.valuewhen(isNewWindow, bar_index, 0)

if showBoxes and not na(currentCandle) and barstate.islast
    // Delete old box
    if not na(currentCandle.bx)
        box.delete(currentCandle.bx)
    
    // Calculate box coordinates
    leftBar = bar_index - (bar_index - windowStartBar)
    rightBar = bar_index + 10
    
    boxColor = getSessionColor(currentCandle.session)
    borderColor = color.new(boxColor, 50)
    
    // Draw box from open to current price
    topPrice = math.max(currentCandle.o, currentCandle.c)
    bottomPrice = math.min(currentCandle.o, currentCandle.c)
    
    // Build text string first
    boxText = currentCandle.session + " 4H\nO: " + str.tostring(currentCandle.o, format.mintick) + "\nH: " + str.tostring(currentCandle.h, format.mintick) + "\nL: " + str.tostring(currentCandle.l, format.mintick)
    
    // Create box with all parameters
    currentCandle.bx := box.new(
      left=leftBar, 
      top=currentCandle.h, 
      right=rightBar, 
      bottom=currentCandle.l, 
      border_color=borderColor, 
      border_width=2, 
      bgcolor=boxColor, 
      text=boxText, 
      text_color=color.white, 
      text_size=size.small, 
      text_halign=text.align_left, 
      text_valign=text.align_top)

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PART 5: INTENT DASHBOARD
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var table dashboard = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 85), border_width=2)

if showDashboard and barstate.islast
    // Header
    table.cell(dashboard, 0, 0, "ICT 4H PROFILER", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.blue, 70))
    table.cell(dashboard, 1, 0, assetMode, text_color=color.yellow, text_size=size.small, bgcolor=color.new(color.blue, 70))
    
    // Current Session
    sessionColor = getSessionColor(currentSession)
    table.cell(dashboard, 0, 1, "STATUS:", text_color=color.gray, text_size=size.small)
    table.cell(dashboard, 1, 1, currentSession, text_color=sessionColor, text_size=size.normal)
    
    // Intent Message
    intentMsg = switch currentSession
        "London" => "REVERSAL WINDOW\nWait for Judas Swing\n(Wick Creation)"
        "NY AM" => "CHECK SWEEP\nDid London Low/High\nget taken?"
        "NY PM" => "EXPANSION MODE\nLook for Order Block\nPullbacks"
        => "MONITORING\nWait for key window..."
    
    table.cell(dashboard, 0, 2, "INTENT:", text_color=color.gray, text_size=size.tiny)
    table.cell(dashboard, 1, 2, intentMsg, text_color=color.white, text_size=size.tiny)
    
    // Current 4H Data
    if not na(currentCandle)
        candleType = currentCandle.c > currentCandle.o ? "BULLISH" : 
                     currentCandle.c < currentCandle.o ? "BEARISH" : "DOJI"
        candleColor = currentCandle.c > currentCandle.o ? color.green : color.red
        
        table.cell(dashboard, 0, 3, "4H BIAS:", text_color=color.gray, text_size=size.tiny)
        table.cell(dashboard, 1, 3, candleType, text_color=candleColor, text_size=size.tiny)
        
        // Open vs Current
        aboveOpen = close > currentCandle.o
        positionText = aboveOpen ? "ABOVE OPEN\n(Premium)" : "BELOW OPEN\n(Discount)"
        positionColor = aboveOpen ? color.green : color.red
        
        table.cell(dashboard, 0, 4, "POSITION:", text_color=color.gray, text_size=size.tiny)
        table.cell(dashboard, 1, 4, positionText, text_color=positionColor, text_size=size.tiny)
    
    // Time remaining
    int minutesInWindow = nyHour * 60 + nyMinute
    int windowStartMinutes = windowStartHour * 60
    int nextWindowMinutes = windowStartMinutes + 240  // 4 hours = 240 minutes
    
    int remaining = nextWindowMinutes > minutesInWindow ? nextWindowMinutes - minutesInWindow : (24 * 60 - minutesInWindow) + nextWindowMinutes
    
    int hoursLeft = math.floor(remaining / 60)
    int minsLeft = remaining % 60
    
    table.cell(dashboard, 0, 5, "TIME LEFT:", text_color=color.gray, text_size=size.tiny)
    table.cell(dashboard, 1, 5, str.tostring(hoursLeft) + "h " + str.tostring(minsLeft) + "m", 
      text_color=color.orange, text_size=size.tiny)

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PART 6: RED FLAG LOGIC (WICK WARNING)
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bool isReversalWindow = currentSession == "London" or currentSession == "NY AM"

var label redFlagLabel = na

if showLabels and isReversalWindow and not na(currentCandle) and barstate.islast
    // Delete old label
    if not na(redFlagLabel)
        label.delete(redFlagLabel)
    
    bool aboveOpen = close > currentCandle.o
    bool belowOpen = close < currentCandle.o
    
    string warningText = ""
    color warningColor = color.orange
    
    if aboveOpen
        // Price is premium (green candle forming) - cannot buy reversal
        warningText := "âš  WAIT FOR RED\nNO WICK YET\n(Above Open)"
        warningColor := color.new(color.red, 30)
    else if belowOpen
        // Price is discount (red candle forming) - cannot sell reversal
        warningText := "âš  WAIT FOR GREEN\nNO WICK YET\n(Below Open)"
        warningColor := color.new(color.green, 30)
    
    if warningText != ""
        redFlagLabel := label.new(x=bar_index, y=high, text=warningText, xloc=xloc.bar_index, yloc=yloc.abovebar, color=warningColor, style=label.style_label_down, textcolor=color.white, size=size.small)

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PART 7: FRACTAL/PIVOT DETECTION
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Pivot High
pivotHigh = ta.pivothigh(high, pivotLength, pivotLength)
bool isPivotHigh = not na(pivotHigh)
pivotHighBar = ta.valuewhen(isPivotHigh, bar_index, 0)
pivotHighPrice = ta.valuewhen(isPivotHigh, high[pivotLength], 0)

// Pivot Low
pivotLow = ta.pivotlow(low, pivotLength, pivotLength)
bool isPivotLow = not na(pivotLow)
pivotLowBar = ta.valuewhen(isPivotLow, bar_index, 0)
pivotLowPrice = ta.valuewhen(isPivotLow, low[pivotLength], 0)

// Track most recent pivot within current 4H window
var float recentPivotHigh = na
var int recentPivotHighBar = na
var float recentPivotLow = na
var int recentPivotLowBar = na

if isNewWindow
    // Reset pivots for new window
    recentPivotHigh := na
    recentPivotHighBar := na
    recentPivotLow := na
    recentPivotLowBar := na

// Update recent pivots
if isPivotHigh
    recentPivotHigh := pivotHighPrice
    recentPivotHighBar := pivotHighBar

if isPivotLow
    recentPivotLow := pivotLowPrice
    recentPivotLowBar := pivotLowBar

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PART 8: CISD ENTRY SIGNALS (NO REPAINT)
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var bool sweepOccurred = false
var float sweepCandleHigh = na
var float sweepCandleLow = na
var int sweepBar = na
var bool isBullishSetup = false
var bool isBearishSetup = false

// Reset on new window
if isNewWindow
    sweepOccurred := false
    sweepCandleHigh := na
    sweepCandleLow := na
    sweepBar := na
    isBullishSetup := false
    isBearishSetup := false

// CISD BULLISH LOGIC (Buy Signal)
// 1. Must be in reversal window
// 2. Price must be below 4H open (discount)
// 3. Sweep a recent pivot low
// 4. Close above high of sweep candle

bool bullishConditions = isReversalWindow and 
  not na(currentCandle) and 
  close < currentCandle.o and
  not na(recentPivotLow)

// Detect sweep of pivot low (current low breaks below pivot low)
if bullishConditions and not sweepOccurred and barstate.isconfirmed
    if low < recentPivotLow
        sweepOccurred := true
        sweepCandleHigh := high
        sweepCandleLow := low
        sweepBar := bar_index
        isBullishSetup := true

// Detect CISD trigger (close above sweep candle high)
var bool cisd_buy_signal = false
cisd_buy_signal := false

if isBullishSetup and sweepOccurred and bar_index > sweepBar and barstate.isconfirmed
    if close > sweepCandleHigh
        cisd_buy_signal := true
        // Reset to prevent duplicate signals
        sweepOccurred := false
        isBullishSetup := false

// CISD BEARISH LOGIC (Sell Signal)
// 1. Must be in reversal window
// 2. Price must be above 4H open (premium)
// 3. Sweep a recent pivot high
// 4. Close below low of sweep candle

bool bearishConditions = isReversalWindow and 
  not na(currentCandle) and 
  close > currentCandle.o and
  not na(recentPivotHigh)

// Detect sweep of pivot high
if bearishConditions and not sweepOccurred and barstate.isconfirmed
    if high > recentPivotHigh
        sweepOccurred := true
        sweepCandleHigh := high
        sweepCandleLow := low
        sweepBar := bar_index
        isBearishSetup := true

// Detect CISD trigger
var bool cisd_sell_signal = false
cisd_sell_signal := false

if isBearishSetup and sweepOccurred and bar_index > sweepBar and barstate.isconfirmed
    if close < sweepCandleLow
        cisd_sell_signal := true
        // Reset to prevent duplicate signals
        sweepOccurred := false
        isBearishSetup := false

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PART 9: PLOT SIGNALS
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plotshape(showSignals and cisd_buy_signal, title="CISD BUY", text="BUY\nCISD", location=location.belowbar, style=shape.labelup, size=size.normal, color=cisdBuyColor, textcolor=color.white)

plotshape(showSignals and cisd_sell_signal, title="CISD SELL", text="SELL\nCISD", location=location.abovebar, style=shape.labeldown, size=size.normal, color=cisdSellColor, textcolor=color.white)

// Plot pivot points for reference (optional)
plotchar(not na(recentPivotLow) and bar_index == recentPivotLowBar, title="Pivot Low", char="L", location=location.belowbar, color=color.new(color.blue, 50), size=size.tiny)

plotchar(not na(recentPivotHigh) and bar_index == recentPivotHighBar, title="Pivot High", char="H", location=location.abovebar, color=color.new(color.red, 50), size=size.tiny)

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PART 10: ALERTS
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(cisd_buy_signal, "CISD BUY SIGNAL", "ğŸŸ¢ CISD BUY SIGNAL on {{ticker}} - Price: {{close}} - Entry NOW - Stop Loss: Below Sweep Low")

alertcondition(cisd_sell_signal, "CISD SELL SIGNAL", "ğŸ”´ CISD SELL SIGNAL on {{ticker}} - Price: {{close}} - Entry NOW - Stop Loss: Above Sweep High")

alertcondition(cisd_buy_signal or cisd_sell_signal, "CISD ANY SIGNAL", "âš¡ CISD SIGNAL TRIGGERED on {{ticker}} at {{close}}")

//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEBUGGING INFO (Optional - can be removed in production)
//â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Plot 4H open as reference line
plot(not na(currentCandle) ? currentCandle.o : na, "4H Open", color.new(color.yellow, 0), 2, plot.style_cross)

// Background color for reversal windows
bgcolor(isReversalWindow ? color.new(color.orange, 95) : na, title="Reversal Window BG")
