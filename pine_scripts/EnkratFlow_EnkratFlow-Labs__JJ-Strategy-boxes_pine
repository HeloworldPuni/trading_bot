//@version=6
indicator("JJ Consolidation Box with Extensions", overlay=true, max_boxes_count=5)

consolidation_bars = input.int(10, "Consolidation Bars", minval=2)
max_height = input.float(2.0, "Max Height Points", minval=0.1)

high_range = ta.highest(high, consolidation_bars)
low_range = ta.lowest(low, consolidation_bars)
range_size = high_range - low_range
is_consolidation = range_size <= max_height

was_consolidation = is_consolidation[1]
new_consolidation = is_consolidation and not was_consolidation

if new_consolidation
    // Draw the blue consolidation box
    box blue_box = box.new(left=bar_index-consolidation_bars+1, right=bar_index+100, top=high_range, bottom=low_range, border_color=color.white, bgcolor=color.new(color.blue, 85))

    // Calculate the height of the boxes
    box_height_val = high_range - low_range

    // Draw the green boxes above
    box.new(left=bar_index-consolidation_bars+1, right=bar_index+100, top=high_range + box_height_val, bottom=high_range, border_color=color.white, bgcolor=color.new(color.green, 85))
    box.new(left=bar_index-consolidation_bars+1, right=bar_index+100, top=high_range + 2 * box_height_val, bottom=high_range + box_height_val, border_color=color.white, bgcolor=color.new(color.green, 85))

    // Draw the red boxes below
    box.new(left=bar_index-consolidation_bars+1, right=bar_index+100, top=low_range, bottom=low_range - box_height_val, border_color=color.white, bgcolor=color.new(color.red, 85))
    box.new(left=bar_index-consolidation_bars+1, right=bar_index+100, top=low_range - box_height_val, bottom=low_range - 2 * box_height_val, border_color=color.white, bgcolor=color.new(color.red, 85))

plotshape(is_consolidation, style=shape.triangleup, location=location.belowbar, color=color.yellow, size=size.tiny)