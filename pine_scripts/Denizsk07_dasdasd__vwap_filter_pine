//@version=5
indicator("Gold VWAP Filter - Session Based", shorttitle="VWAP Filter", overlay=true)

// ===== EINGABEPARAMETER =====
// VWAP Settings
vwap_source = input.source(hlc3, "VWAP Source", group="VWAP Settings")
show_vwap = input.bool(true, "Show VWAP Line", group="VWAP Settings")
vwap_line_width = input.int(2, "VWAP Line Width", minval=1, maxval=4, group="VWAP Settings")

// VWAP Bands
show_bands = input.bool(true, "Show VWAP Bands", group="VWAP Bands")
std_dev_1 = input.float(1.0, "Standard Deviation 1", minval=0.1, maxval=3.0, step=0.1, group="VWAP Bands")
std_dev_2 = input.float(2.0, "Standard Deviation 2", minval=0.1, maxval=3.0, step=0.1, group="VWAP Bands")
band_transparency = input.int(85, "Band Transparency", minval=0, maxval=100, group="VWAP Bands")

// Trading Filter Settings
enable_trading_filter = input.bool(true, "Enable Trading Filter", group="Trading Filter")
filter_buffer_pips = input.float(2.0, "Filter Buffer (Pips)", minval=0, maxval=10, step=0.5, group="Trading Filter")
show_filter_zones = input.bool(true, "Show Long/Short Zones", group="Trading Filter")

// Session Settings
session_reset_time = input.session("0000-0000", "Session Reset Time", group="Session Settings")
use_german_time = input.bool(true, "Use German Time Zone", group="Session Settings")
show_session_info = input.bool(true, "Show Session Info", group="Session Settings")

// Alert Settings
enable_alerts = input.bool(false, "Enable VWAP Alerts", group="Alerts")
cross_alert_threshold = input.float(5.0, "Cross Alert Threshold (Pips)", minval=1, maxval=20, group="Alerts")

// Colors
vwap_color = input.color(color.blue, "VWAP Color", group="Colors")
upper_band_color = input.color(color.red, "Upper Band Color", group="Colors") 
lower_band_color = input.color(color.green, "Lower Band Color", group="Colors")
long_zone_color = input.color(color.new(color.green, 90), "Long Zone Color", group="Colors")
short_zone_color = input.color(color.new(color.red, 90), "Short Zone Color", group="Colors")

// ===== KONSTANTEN =====
PIP_SIZE = 0.01 // XAU/USD Pip-Definition

// ===== DEUTSCHE ZEITZONE BERECHNUNG =====
// Deutsche Zeit berücksichtigen (UTC+1/+2)
is_dst = month >= 3 and month <= 10 // Vereinfachte Sommerzeit-Erkennung
utc_offset = is_dst ? 2 : 1
current_hour_de = use_german_time ? (hour + utc_offset) % 24 : hour

// ===== SESSION VWAP BERECHNUNG =====
// Session Reset Detection (täglich um 00:00 deutsche Zeit)
is_new_session = use_german_time ? 
    (current_hour_de == 0 and minute == 0) : 
    ta.change(time("1D"))

// VWAP Variablen
var float vwap_sum = 0.0
var float volume_sum = 0.0
var float session_vwap = na
var int session_start_time = 0
var float[] price_history = array.new<float>()

// Session Reset
if is_new_session
    vwap_sum := 0.0
    volume_sum := 0.0
    session_vwap := na
    session_start_time := time
    array.clear(price_history)

// VWAP Berechnung
current_volume = volume > 0 ? volume : 1
typical_price = vwap_source

if not na(typical_price)
    vwap_sum += typical_price * current_volume
    volume_sum += current_volume
    session_vwap := volume_sum > 0 ? vwap_sum / volume_sum : typical_price
    
    // Price History für Standardabweichung
    array.push(price_history, typical_price)
    if array.size(price_history) > 500
        array.shift(price_history)

// ===== VWAP BÄNDER BERECHNUNG =====
// Standardabweichung berechnen
calculate_std_dev() =>
    if array.size(price_history) < 20 or na(session_vwap)
        0.0
    else
        sum_squared_diff = 0.0
        history_size = array.size(price_history)
        
        // Verwende letzten 50 Datenpunkte für Std-Berechnung
        lookback = math.min(50, history_size)
        
        for i = 0 to lookback - 1
            price_val = array.get(price_history, history_size - 1 - i)
            diff = price_val - session_vwap
            sum_squared_diff += diff * diff
        
        math.sqrt(sum_squared_diff / lookback)

std_dev = calculate_std_dev()

// VWAP Bänder
vwap_upper_1 = session_vwap + (std_dev * std_dev_1)
vwap_lower_1 = session_vwap - (std_dev * std_dev_1)
vwap_upper_2 = session_vwap + (std_dev * std_dev_2)
vwap_lower_2 = session_vwap - (std_dev * std_dev_2)

// ===== TRADING FILTER LOGIK =====
// Filter Buffer
filter_buffer = filter_buffer_pips * PIP_SIZE

// Long/Short Zonen definieren
long_zone_lower = session_vwap - filter_buffer
short_zone_upper = session_vwap + filter_buffer

// Trading Filter Signale
is_long_allowed = close >= long_zone_lower
is_short_allowed = close <= short_zone_upper

// VWAP Position Analysis
distance_to_vwap = close - session_vwap
distance_pips = distance_to_vwap / PIP_SIZE

vwap_position = distance_pips > filter_buffer_pips ? "Above VWAP" :
                distance_pips < -filter_buffer_pips ? "Below VWAP" :
                "At VWAP"

// ===== SESSION ANALYSE =====
// Bestimme aktuelle Session
get_current_session() =>
    if use_german_time
        if current_hour_de >= 8 and current_hour_de <= 11
            "London"
        else if current_hour_de >= 14.5 and current_hour_de <= 17
            "New York" 
        else if current_hour_de >= 19 and current_hour_de <= 21
            "Scalping"
        else
            "Asian"
    else
        if hour >= 7 and hour <= 10
            "London"
        else if hour >= 13.5 and hour <= 16
            "New York"
        else
            "Asian"

current_session = get_current_session()

// ===== VWAP TREND ANALYSE =====
// VWAP Slope berechnen (vereinfacht)
vwap_change = ta.change(session_vwap, 10)
vwap_trend = vwap_change > 0.02 ? "Bullish" : 
             vwap_change < -0.02 ? "Bearish" : 
             "Neutral"

// VWAP Strength (basierend auf Preis-Clustering um VWAP)
vwap_strength = math.abs(distance_pips) <= 1 ? "Strong" :
                math.abs(distance_pips) <= 5 ? "Medium" :
                "Weak"

// ===== VISUALISIERUNG =====
// VWAP Line
plot(show_vwap and not na(session_vwap) ? session_vwap : na, 
     "Session VWAP", vwap_color, vwap_line_width, plot.style_line)

// VWAP Bands
upper1_plot = plot(show_bands and not na(vwap_upper_1) ? vwap_upper_1 : na, 
                   "Upper Band 1", color.new(upper_band_color, band_transparency), 1)
lower1_plot = plot(show_bands and not na(vwap_lower_1) ? vwap_lower_1 : na, 
                   "Lower Band 1", color.new(lower_band_color, band_transparency), 1)

upper2_plot = plot(show_bands and not na(vwap_upper_2) ? vwap_upper_2 : na, 
                   "Upper Band 2", color.new(upper_band_color, band_transparency), 1, plot.style_circles)
lower2_plot = plot(show_bands and not na(vwap_lower_2) ? vwap_lower_2 : na, 
                   "Lower Band 2", color.new(lower_band_color, band_transparency), 1, plot.style_circles)

// Band Fills
if show_bands
    fill(upper1_plot, upper2_plot, color.new(upper_band_color, 95), "Upper Fill")
    fill(lower1_plot, lower2_plot, color.new(lower_band_color, 95), "Lower Fill")

// Trading Filter Zones
if show_filter_zones and enable_trading_filter and not na(session_vwap)
    // Long Zone (grün unter VWAP)
    long_zone_upper = session_vwap
    bgcolor(close <= long_zone_upper and close >= long_zone_lower ? long_zone_color : na, "Long Zone")
    
    // Short Zone (rot über VWAP)  
    short_zone_lower = session_vwap
    bgcolor(close >= short_zone_lower and close <= short_zone_upper ? short_zone_color : na, "Short Zone")

// ===== ALERTS =====
// VWAP Cross Detection
vwap_cross_up = ta.crossover(close, session_vwap)
vwap_cross_down = ta.crossunder(close, session_vwap)

// Price Distance Alerts
price_far_above = distance_pips > cross_alert_threshold
price_far_below = distance_pips < -cross_alert_threshold

if enable_alerts
    alertcondition(vwap_cross_up, "VWAP Cross Up", "Price crossed above VWAP: {{close}}")
    alertcondition(vwap_cross_down, "VWAP Cross Down", "Price crossed below VWAP: {{close}}")
    alertcondition(price_far_above, "Price Far Above VWAP", "Price {{distance_pips}} pips above VWAP")
    alertcondition(price_far_below, "Price Far Below VWAP", "Price {{distance_pips}} pips below VWAP")

// ===== TRADING SIGNALS =====
// Long Signal (Price at or above VWAP)
long_signal_condition = enable_trading_filter and is_long_allowed and close >= session_vwap
plotshape(long_signal_condition and not long_signal_condition[1], 
          "Long Signal", shape.triangleup, location.belowbar, color.green, size=size.small)

// Short Signal (Price at or below VWAP)  
short_signal_condition = enable_trading_filter and is_short_allowed and close <= session_vwap
plotshape(short_signal_condition and not short_signal_condition[1], 
          "Short Signal", shape.triangledown, location.abovebar, color.red, size=size.small)

// ===== INFORMATIONS-TABELLE =====
if show_session_info and barstate.islast
    var table vwap_table = table.new(position.top_right, 2, 8, bgcolor=color.white, border_width=1)
    
    table.cell(vwap_table, 0, 0, "VWAP INFO", text_color=color.black, bgcolor=color.gray)
    table.cell(vwap_table, 1, 0, "VALUE", text_color=color.black, bgcolor=color.gray)
    
    table.cell(vwap_table, 0, 1, "Current VWAP", text_color=color.black)
    table.cell(vwap_table, 1, 1, str.tostring(session_vwap, "#.##"), text_color=color.black)
    
    table.cell(vwap_table, 0, 2, "Distance", text_color=color.black)
    table.cell(vwap_table, 1, 2, str.tostring(distance_pips, "#.#") + " pips", 
               text_color=distance_pips > 0 ? color.green : color.red)
    
    table.cell(vwap_table, 0, 3, "Position", text_color=color.black)
    table.cell(vwap_table, 1, 3, vwap_position, text_color=color.black)
    
    table.cell(vwap_table, 0, 4, "Trend", text_color=color.black)
    table.cell(vwap_table, 1, 4, vwap_trend, 
               text_color=vwap_trend == "Bullish" ? color.green : 
                         vwap_trend == "Bearish" ? color.red : color.gray)
    
    table.cell(vwap_table, 0, 5, "Session", text_color=color.black)
    table.cell(vwap_table, 1, 5, current_session, text_color=color.black)
    
    table.cell(vwap_table, 0, 6, "Long OK", text_color=color.black)
    table.cell(vwap_table, 1, 6, is_long_allowed ? "✅" : "❌", text_color=color.black)
    
    table.cell(vwap_table, 0, 7, "Short OK", text_color=color.black)
    table.cell(vwap_table, 1, 7, is_short_allowed ? "✅" : "❌", text_color=color.black)

// ===== ZUSÄTZLICHE PLOTS FÜR DEBUGGING =====
// Unsichtbare Plots für Alert-Variablen
plot(distance_pips, "Distance Pips", color.new(color.white, 100), display=display.none)
plot(is_long_allowed ? 1 : 0, "Long Allowed", color.new(color.white, 100), display=display.none)
plot(is_short_allowed ? 1 : 0, "Short Allowed", color.new(color.white, 100), display=display.none)

// ===== VWAP QUALITÄTS-INDIKATOR =====
// VWAP Quality Score basierend auf Volume und Price Action
volume_ratio = volume / ta.sma(volume, 20)
price_volatility = ta.atr(14) / session_vwap

vwap_quality = volume_ratio > 1.2 and price_volatility > 0.001 ? "High" :
               volume_ratio > 0.8 and price_volatility > 0.0005 ? "Medium" :
               "Low"

// Quality Indicator (nur in Tabelle anzeigen)
if barstate.islast and show_session_info
    var table quality_table = table.new(position.bottom_right, 2, 4, bgcolor=color.white, border_width=1)
    
    table.cell(quality_table, 0, 0, "QUALITY", text_color=color.black, bgcolor=color.gray)
    table.cell(quality_table, 1, 0, "STATUS", text_color=color.black, bgcolor=color.gray)
    
    table.cell(quality_table, 0, 1, "VWAP Quality", text_color=color.black)
    table.cell(quality_table, 1, 1, vwap_quality, 
               text_color=vwap_quality == "High" ? color.green : 
                         vwap_quality == "Medium" ? color.orange : color.red)
    
    table.cell(quality_table, 0, 2, "Volume Ratio", text_color=color.black)
    table.cell(quality_table, 1, 2, str.tostring(volume_ratio, "#.##") + "x", text_color=color.black)
    
    table.cell(quality_table, 0, 3, "Std Dev", text_color=color.black)
    table.cell(quality_table, 1, 3, str.tostring(std_dev, "#.##"), text_color=color.black)

// ===== HINTERGRUND-HIGHLIGHTING =====
// Highlight Trading Sessions mit schwacher VWAP-Hintergrundfarbe
london_session_active = current_session == "London"
ny_session_active = current_session == "New York"

bgcolor(london_session_active ? color.new(color.yellow, 95) : na, "London Session")
bgcolor(ny_session_active ? color.new(color.blue, 95) : na, "NY Session")