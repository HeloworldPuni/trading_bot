//@version=6
indicator("EMA, Vol, VWAP, Session", overlay=true, max_lines_count=500, max_labels_count=500, max_bars_back=5000)

// MA Settings
matype = input.string(defval = "EMA", title = "MA Type", options = ["EMA", "SMA"], group="MA Settings")

// Volume Settings
volMaLength = input.int(30, title="Volume MA Length", minval=1, group="Volume Settings")
volMultiplier1 = input.float(1.5, title="Volume Multiplier 1", minval=1, group="Volume Settings")
volMultiplier2 = input.float(2, title="Volume Multiplier 2", minval=1, group="Volume Settings")

// MA
ma20 = matype == "EMA" ? ta.ema(close, 20) : ta.sma(close, 20)
ma50 = matype == "EMA" ? ta.ema(close, 50) : ta.sma(close, 50)
ma100 = matype == "EMA" ? ta.ema(close, 100) : ta.sma(close, 100)
ma200 = matype == "EMA" ? ta.ema(close, 200) : ta.sma(close, 200)
ma20Plot = plot(ma20, title="MA 20", color = color.new(#4caf50, 70))
ma50Plot = plot(ma50, title="MA 50", color = color.new(#ffeb3b, 70))
ma100Plot = plot(ma100, title="MA 100", color = color.new(#f44336, 70))
ma200Plot = plot(ma200, title="MA 200", color = color.new(#9c27b0, 70))

// Vol
var color volBullishBase = #4caf50
var color volBearishBase = #f44336
var color volBullishHigh = #a5d6a7
var color volBearishHigh = #ef9a9a

volMa = ta.ema(volume, volMaLength)
hasLargeVol1 = volume > volMultiplier1 * volMa
hasLargeVol2 = volume > volMultiplier2 * volMa
barcolor(hasLargeVol1 ? (close > open ? (hasLargeVol2 ? volBullishHigh : volBullishBase) : (hasLargeVol2 ? volBearishHigh : volBearishBase)) : na, title="Volume Bar Color")

// VWAP
hideonDWM = input(false, title="Hide VWAP on 1D or Above", group="VWAP Settings", display = display.data_window)
src = input(title = "Source", defval = hlc3, group="VWAP Settings", display = display.data_window)
offset = input.int(0, title="Offset", group="VWAP Settings", minval=0, display = display.data_window)
showVwapSession = input.bool(true, title="Show Session VWAP", group="VWAP Settings", display = display.data_window)
showVwapWeek = input.bool(true, title="Show Week VWAP", group="VWAP Settings", display = display.data_window)
showVwapMonth = input.bool(true, title="Show Month VWAP", group="VWAP Settings", display = display.data_window)
bandMultiplier = input.float(2.0, title="Session VWAP Band Multiplier", minval=0, step=0.5, group="VWAP Settings", display = display.data_window)

cumVolume = ta.cum(volume)
if barstate.islast and cumVolume == 0
    runtime.error("No volume is provided by the data vendor.")

// Session VWAP
isNewSession = timeframe.change("D")
if na(src[1])
    isNewSession := true

// Week VWAP
isNewWeek = timeframe.change("W")
if na(src[1])
    isNewWeek := true

// Month VWAP
isNewMonth = timeframe.change("M")
if na(src[1])
    isNewMonth := true

float vwapSession = na
float vwapWeek = na
float vwapMonth = na
float upperBand = na
float lowerBand = na

if not (hideonDWM and timeframe.isdwm)
    // Session VWAP base value & stdev for bands (only one pair requested)
    if showVwapSession
        [_vwapSession, _stdevUpperSession, _] = ta.vwap(src, isNewSession, 1)
        vwapSession := _vwapSession
        stdevAbsSession = _stdevUpperSession - _vwapSession
        upperBand := _vwapSession + stdevAbsSession * bandMultiplier
        lowerBand := _vwapSession - stdevAbsSession * bandMultiplier
    else
        vwapSession := ta.vwap(src, isNewSession)

    if showVwapWeek
        vwapWeek := ta.vwap(src, isNewWeek)
    if showVwapMonth
        vwapMonth := ta.vwap(src, isNewMonth)

sessionPlot = plot(showVwapSession ? vwapSession : na, title = "VWAP Session", color = color.new(#2962FF, 70), offset = offset, linewidth = 2, display = showVwapSession ? display.all : display.none)
weekPlot = plot(showVwapWeek ? vwapWeek : na, title = "VWAP Week", color = color.new(#FF6D00, 70), offset = offset, linewidth = 2, display = showVwapWeek ? display.all : display.none)
monthPlot = plot(showVwapMonth ? vwapMonth : na, title = "VWAP Month", color = color.new(#8E24AA, 70), offset = offset, linewidth = 2, display = showVwapMonth ? display.all : display.none)

upperBandPlot = plot(showVwapSession ? upperBand : na, title="Session VWAP Upper Band", color=color.new(color.green, 70), offset=offset, display = showVwapSession ? display.all : display.none)
lowerBandPlot = plot(showVwapSession ? lowerBand : na, title="Session VWAP Lower Band", color=color.new(color.green, 70), offset=offset, display = showVwapSession ? display.all : display.none)

// This work is licensed under a Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// Â© LuxAlgo

//------------------------------------------------------------------------------
//Settings
//-----------------------------------------------------------------------------{
//Session A
show_sesa = input.bool(true, '', inline = 'sesa', group = 'Session A')
sesa_txt = input.string('New York', '', inline = 'sesa', group = 'Session A')
sesa_ses = input.session('1300-2200', '', inline = 'sesa', group = 'Session A')
sesa_css = input.color(#ff5d00, '', inline = 'sesa', group = 'Session A')

// Session A range always enabled

//Session B
show_sesb = input.bool(true, '', inline = 'sesb', group = 'Session B')
sesb_txt = input.string('London', '', inline = 'sesb', group = 'Session B')
sesb_ses = input.session('0700-1600', '', inline = 'sesb', group = 'Session B')
sesb_css = input.color(#2157f3, '', inline = 'sesb', group = 'Session B')

// Session B range always enabled

//Session C
show_sesc = input.bool(true, '', inline = 'sesc', group = 'Session C')
sesc_txt = input.string('Tokyo', '', inline = 'sesc', group = 'Session C')
sesc_ses = input.session('0000-0900', '', inline = 'sesc', group = 'Session C')
sesc_css = input.color(#e91e63, '', inline = 'sesc', group = 'Session C')

// Session C range always enabled

//Session D
show_sesd = input.bool(true, '', inline = 'sesd', group = 'Session D')
sesd_txt = input.string('Sydney', '', inline = 'sesd', group = 'Session D')
sesd_ses = input.session('2100-0600', '', inline = 'sesd', group = 'Session D')
sesd_css = input.color(#ffeb3b, '', inline = 'sesd', group = 'Session D')

// Session D range always enabled

//Timezones
tz_incr = input.int(0, 'UTC (+/-)', group = 'Timezone')
use_exchange = input.bool(false, 'Use Exchange Timezone', group = 'Timezone')

//Range Label Option (background & outline removed per request)
show_txt = input.bool(true, 'Range Label', group = 'Ranges Settings')

float chartTFInMinutes = timeframe.in_seconds() / 60

//-----------------------------------------------------------------------------}
//Functions
//-----------------------------------------------------------------------------{

//Get session average
get_avg(session)=>
    var len = 1
    var float csma = na
    var float sma = na

    if session > session[1]
        len := 1
        csma := close
    
    if session != 0 and session == session[1]
        len += 1    
        csma += close
        sma := csma / len
    
    sma

//Get trendline coordinates
get_linreg(session)=>
    var len = 1
    var float cwma  = na
    var float csma  = na
    var float csma2 = na

    var float y1 = na
    var float y2 = na
    var float stdev = na 
    var float r2    = na 

    if session > session[1]
        len   := 1
        cwma  := close
        csma  := close
        csma2 := close * close
    
    if session != 0 and session == session[1]
        len   += 1    
        csma  += close
        csma2 += close * close
        cwma  += close * len

        sma = csma / len
        wma = cwma / (len * (len + 1) / 2)

        cov   = (wma - sma) * (len+1)/2
        stdev := math.sqrt(csma2 / len - sma * sma)
        r2    := cov / (stdev * (math.sqrt(len*len - 1) / (2 * math.sqrt(3))))

        y1 := 4 * sma - 3 * wma
        y2 := 3 * wma - 2 * sma

    [y1 , y2, stdev, r2]

//Session Vwap
get_vwap(session) =>
    var float num = na
    var float den = na

    if session > session[1]
        num := close * volume
        den := volume
    
    else if session != 0 and session == session[1]
        num += close * volume
        den += volume
    else
        num := na

    [num, den]

//Set session range
get_session_bars(session_str)=>
    parts = str.split(session_str, "-")
    start_str = array.get(parts, 0)
    end_str = array.get(parts, 1)

    start_minutes = str.tonumber(str.substring(start_str, 0, 2)) * 60 + str.tonumber(str.substring(start_str, 2, 4))
    end_minutes = str.tonumber(str.substring(end_str, 0, 2)) * 60 + str.tonumber(str.substring(end_str, 2, 4))
    duration_minutes = end_minutes - start_minutes
    duration_minutes := duration_minutes <= 0 ? duration_minutes + 1440 : duration_minutes

    bars = math.max(1, math.ceil(duration_minutes / chartTFInMinutes))
    int(bars)

//Pre-draw session ranges using lines: show current session outline and preview the next session one day ahead
get_range(session, session_name, session_css, session_bars)=>
    var int start_time = na
    var float max = na
    var float min = na
    var line top_line = na
    var line bottom_line = na
    var line left_line = na
    var line right_line = na
    var line next_top_line = na
    var line next_bottom_line = na
    var line next_left_line = na
    var line next_right_line = na
    var label lbl = na

    session_ms = int(session_bars * chartTFInMinutes * 60000)
    day_ms = 86400000

    new_session = session > session[1]
    active_session = session != 0 and session == session[1]
    ended_session = session == 0 and session[1] != 0

    if new_session
        start_time := time
        max := high
        min := low
        end_time = start_time + session_ms

        // Delete old lines if recreating
        if not na(top_line)
            line.delete(top_line)
        if not na(bottom_line)
            line.delete(bottom_line)
        if not na(left_line)
            line.delete(left_line)
        if not na(right_line)
            line.delete(right_line)

        // Create current session lines
        top_line := line.new(start_time, max, end_time, max, xloc=xloc.bar_time, color=session_css, style=line.style_dotted)
        bottom_line := line.new(start_time, min, end_time, min, xloc=xloc.bar_time, color=session_css, style=line.style_dotted)
        left_line := line.new(start_time, max, start_time, min, xloc=xloc.bar_time, color=session_css, style=line.style_dotted)
        right_line := line.new(end_time, max, end_time, min, xloc=xloc.bar_time, color=session_css, style=line.style_dotted)

        // Delete old next session lines if recreating
        if not na(next_top_line)
            line.delete(next_top_line)
        if not na(next_bottom_line)
            line.delete(next_bottom_line)
        if not na(next_left_line)
            line.delete(next_left_line)
        if not na(next_right_line)
            line.delete(next_right_line)

        // Create next session lines (preview for tomorrow)
        next_start = start_time + day_ms
        next_end = next_start + session_ms
        next_top_line := line.new(next_start, max, next_end, max, xloc=xloc.bar_time, color=session_css, style=line.style_dotted)
        next_bottom_line := line.new(next_start, min, next_end, min, xloc=xloc.bar_time, color=session_css, style=line.style_dotted)
        next_left_line := line.new(next_start, max, next_start, min, xloc=xloc.bar_time, color=session_css, style=line.style_dotted)
        next_right_line := line.new(next_end, max, next_end, min, xloc=xloc.bar_time, color=session_css, style=line.style_dotted)

        if show_txt
            mid_time = start_time + session_ms / 2
            if na(lbl)
                lbl := label.new(mid_time, max, session_name
                   , xloc = xloc.bar_time
                   , textcolor = session_css
                   , style = label.style_label_down
                   , color = color.new(color.white, 100)
                   , size = size.tiny)
            else
                label.set_xy(lbl, mid_time, max)
                label.set_text(lbl, session_name)
                label.set_textcolor(lbl, session_css)

    if active_session
        max := math.max(high, max)
        min := math.min(low, min)

        if not na(top_line)
            line.set_y1(top_line, max)
            line.set_y2(top_line, max)
        if not na(bottom_line)
            line.set_y1(bottom_line, min)
            line.set_y2(bottom_line, min)
        if not na(left_line)
            line.set_y1(left_line, max)
            line.set_y2(left_line, min)
        if not na(right_line)
            line.set_y1(right_line, max)
            line.set_y2(right_line, min)

        if show_txt and not na(lbl)
            label.set_xy(lbl, start_time + session_ms / 2, max)

    if ended_session
        end_time = time

        if not na(right_line)
            line.set_x1(right_line, end_time)
            line.set_x2(right_line, end_time)

        if not na(next_top_line)
            line.set_y1(next_top_line, max)
            line.set_y2(next_top_line, max)
        if not na(next_bottom_line)
            line.set_y1(next_bottom_line, min)
            line.set_y2(next_bottom_line, min)
        if not na(next_left_line)
            line.set_y1(next_left_line, max)
            line.set_y2(next_left_line, min)
        if not na(next_right_line)
            line.set_y1(next_right_line, max)
            line.set_y2(next_right_line, min)

    [ended_session ? max : na, ended_session ? min : na]

//-----------------------------------------------------------------------------}
//Sessions
//-----------------------------------------------------------------------------{
tf = timeframe.period

var tz = use_exchange ? syminfo.timezone :
  str.format('UTC{0}{1}', tz_incr >= 0 ? '+' : '-', math.abs(tz_incr))

is_sesa = math.sign(nz(time(tf, sesa_ses, tz)))
is_sesb = math.sign(nz(time(tf, sesb_ses, tz)))
is_sesc = math.sign(nz(time(tf, sesc_ses, tz)))
is_sesd = math.sign(nz(time(tf, sesd_ses, tz)))

sesa_bars = get_session_bars(sesa_ses)
sesb_bars = get_session_bars(sesb_ses)
sesc_bars = get_session_bars(sesc_ses)
sesd_bars = get_session_bars(sesd_ses)

//-----------------------------------------------------------------------------}
//Overlays
//-----------------------------------------------------------------------------{
var float max_sesa = na
var float min_sesa = na
var float max_sesb = na
var float min_sesb = na
var float max_sesc = na
var float min_sesc = na
var float max_sesd = na
var float min_sesd = na
      
//Ranges
if chartTFInMinutes <= 15 and show_sesa
    [max, min] = get_range(is_sesa, sesa_txt, sesa_css, sesa_bars)
    max_sesa := max
    min_sesa := min

if chartTFInMinutes <= 15 and show_sesb
    [max, min] = get_range(is_sesb, sesb_txt, sesb_css, sesb_bars)
    max_sesb := max
    min_sesb := min

if chartTFInMinutes <= 15 and show_sesc
    [max, min] = get_range(is_sesc, sesc_txt, sesc_css, sesc_bars)
    max_sesc := max
    min_sesc := min

if chartTFInMinutes <= 15 and show_sesd
    [max, min] = get_range(is_sesd, sesd_txt, sesd_css, sesd_bars)
    max_sesd := max
    min_sesd := min