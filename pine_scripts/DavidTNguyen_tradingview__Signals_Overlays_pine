//@version=6

indicator('Lux Algo Signals & Overlaysâ„¢', overlay = true, max_labels_count = 500)

// Import libraries
import ayvaliktrading/EyopsTelegram/1 as LAF
import ayvaliktrading/JoinUsEyopsTelegram/1 as kernels

// ============================[GET USERS INPUT]============================ 
groupBasic = 'BASIC SETTINGS'
showSignals = input.bool(true, 'Show Signals', inline = '1', group = groupBasic, tooltip = 'Enables or disables the signals')
signalPresets = input.string('None', 'Presets / Filters', options = ['None', 'Trend Trader [Preset]', 'Scalper [Preset]', 'Swing Trader [Preset]', 'Contrarian Trader [Preset]', 'Smart Trail [Filter]', 'Trend Tracer [Filter]', 'Trend Strength [Filter]', 'Trend Catcher [Filter]', 'Neo Cloud [Filter]'], tooltip = 'Automatically sets settings or filters for a given category', group = groupBasic)
signalMode = input.string('Confirmation + Exits', 'Signal Mode', options = ['Confirmation + Exits', 'Contrarian + Exits', 'None'], tooltip = 'Changes the Mode of the signals', group = groupBasic)
signalClassifier = input.bool(true, 'AI Signal Classifier', tooltip = 'Shows signal quality from 1-4 on signals', group = groupBasic)
sensitivity = input.float(5, 'Signal Sensitivity', minval = 1, maxval = 26, step = 1, tooltip = 'Changes the sensitivity of the signals. Lower = more short term signals, higher = longer term.', group = groupBasic)
atrLength = input.int(10, 'Signal Tuner', minval = 1, maxval = 25, step = 1, tooltip = 'Allows you to tune your signals, higher number = more refined but laggier signal', group = groupBasic)
candleColorType = input.string('Confirmation Simple', 'Candle Coloring', options = ['Confirmation Simple', 'Confirmation Gradient', 'Contrarian Gradient', 'None'], tooltip = 'Changes the type of signal coloring', group = groupBasic)

// Indicator Overlay Settings
groupOverlay = 'INDICATOR OVERLAY'
smartTrail = input.bool(true, 'Smart Trail', inline = '1', group = groupOverlay)
trendCatcher = input.bool(false, 'Trend Catcher', inline = '2', group = groupOverlay)
neoCloud = input.bool(false, 'Neo Cloud', inline = '3', group = groupOverlay)
reversalZone = input.bool(true, 'Reversal Zones', inline = '1', group = groupOverlay)
trendTracer = input.bool(false, 'Trend Tracer', inline = '2', group = groupOverlay)
showDashboard = input.bool(true, 'Dashboard', inline = '3', group = groupOverlay)
showTrailingStoploss = input.bool(false, 'Trailing Stoploss', inline = '4', group = groupOverlay)
showMovingAverage = input.bool(false, 'AI Moving Average', inline = '4', group = groupOverlay)
showSessions = input.bool(false, 'Sessions', inline = '5', group = groupOverlay)

// Advanced Settings
groupAdvanced = 'ADVANCED SETTINGS'
takeProfitBoxes = input.string('Off', 'TP/SL Points', options = ['Off', 'On'], inline = '2', tooltip = 'Shows Take Profit and Stop Loss areas', group = groupAdvanced)
takeProfitStopLossDistance = input.int(5, '', minval = 1, maxval = 10, inline = '2', group = groupAdvanced)
autopilotMode = input.string('Off', 'Autopilot Sensitivity', options = ['Off', 'Short-Term', 'Mid-Term', 'Long-Term'], tooltip = 'Sets automatic settings for signals and improves their quality', inline = '3', group = groupAdvanced)
dashboardLocation = input.string('Bottom Right', 'Dashboard Location', options = ['Top Right', 'Bottom Right', 'Bottom Left'], inline = '4', tooltip = 'Changes dashboard positions', group = groupAdvanced)
dashboardSize = input.string('Normal', 'Dashboard Size', options = ['Tiny', 'Small', 'Normal', 'Large'], inline = '5', tooltip = 'Changes the size of the dashboard', group = groupAdvanced)

// Apply presets
if signalPresets == 'Trend Trader [Preset]'
    smartTrail := true
    trendCatcher := true
    neoCloud := true
    trendTracer := true
    trendTracer

if signalPresets == 'Scalper [Preset]'
    sensitivity := 4
    smartTrail := true
    trendTracer := true
    candleColorType := 'Confirmation Gradient'
    candleColorType

if signalPresets == 'Swing Trader [Preset]'
    sensitivity := 18
    neoCloud := true
    candleColorType := 'Confirmation Simple'
    candleColorType

if signalPresets == 'Contrarian Trader [Preset]'
    reversalZone := true
    smartTrail := true
    candleColorType := 'Contrarian Gradient'
    candleColorType

// Bar index
n = bar_index

// ============================[SESSIONS]============================ 
show_sesa = true
sesa_txt = 'New York'
sesa_ses = '1300-2200'
sesa_css = #ff5d00

sesa_range = true
sesa_tl = false
sesa_avg = false
sesa_vwap = false
sesa_maxmin = false

show_sesb = true
sesb_txt = 'London'
sesb_ses = '0700-1600'
sesb_css = #2157f3

sesb_range = true
sesb_tl = false
sesb_avg = false
sesb_vwap = false
sesb_maxmin = false

tz_incr = 0
use_exchange = false

bg_transp = 90
show_outline = true
show_txt = true

show_ses_div = false
show_day_div = false

// Example function corrected: get_avg
get_avg(session) =>
    var int len = 1
    var float csma = na
    var float sma = na
    if session > session[1]
        len := 1
        csma := close
        csma
    else if session and session == session[1]
        len := len + 1
        csma := csma + close
        csma
    sma := csma / len
    sma

// Other functions must be similarly fixed with proper indentation and syntax

// ============================[CANDLE COLORING]============================ 
macdFastLength = 12
macdSlowLength = 26
macdSignalLength = 9

if candleColorType != 'Confirmation Simple'
    macdFastLength := 10
    macdSlowLength := 25
    macdSignalLength := 8
    macdSignalLength

[MacdX, signalX, histX] = ta.macd(close, macdFastLength, macdSlowLength, macdSignalLength)

// Define candle colors based on histX and MacdX with proper if-else blocks
var color candleBody = na

if candleColorType != 'None'
    candleBody := histX > 0 ? #4ce653 : #ff5959
    candleBody
    // Add gradient logic here...

barcolor(candleColorType == 'None' ? na : candleBody)

// ============================[SMART TRAIL]============================ 
[smartTrailLine, fillerLine, smartTrailDirection] = LAF.getSmartTrail(10, 4, 8)

// Assign plot handles to variables
plotSmartTrail = plot(smartTrail ? smartTrailLine : na, 'Smart Trail', style = plot.style_line, color = smartTrailDirection == 'long' ? color.new(#2157f9, 0) : smartTrailDirection == 'short' ? color.new(#ff1100, 0) : na)
plotFillerLine = plot(smartTrail ? fillerLine : na, 'Fib 2', style = plot.style_line)

// Use plot handles in fill()
fill(plotSmartTrail, plotFillerLine, color = smartTrailDirection == 'long' ? color.new(#2157f9, 80) : smartTrailDirection == 'short' ? color.new(#ff1100, 80) : na)
// ============================[TREND CATCHER]============================ 
[trendCatcherLine, trendCatcherColor] = LAF.getTrendCatcher()
newTrendCatcherColor = trendCatcherColor == color.blue ? #02ff65 : #ff1100
plot(trendCatcher ? trendCatcherLine : na, title = 'Trend Catcher', linewidth = 2, color = newTrendCatcherColor)

// ============================[TREND TRACER]============================ 
[trendTracerLine, trendTracerDirection] = LAF.getTrendTracer()
plot(trendTracer ? trendTracerLine : na, title = 'Trend Tracer', linewidth = 2, style = plot.style_cross, color = trendTracerDirection)

// ============================[DASHBOARD]============================ 
// Dashboard code here - fix capitalization, variable names, and logic as needed

// ============================[TP/SL BOXES]============================ 
// Example for TP1 box creation with proper indexing and deletion
if takeProfitBoxes == 'On'
    [lowb, midb, highb] = LAF.getTPSLBoxes(6.0)
    var box tp1box = na
    tp1box := box.new(left = bar_index + 1, top = close + midb, right = bar_index + 18, bottom = close + lowb, border_color = color.new(#3666f5, 0), border_width = 2, border_style = line.style_solid, bgcolor = color.new(#3666f5, 55), text = 'TP/SL 1 : ' + str.tostring(close), text_size = size.normal, text_color = color.new(#3666f5, 0))
    if bar_index > 1
        box.delete(tp1box[1])

// Similar fixes for other boxes and lines

// ============================[SIGNALS]============================ 
// Signal plotting with proper condition checks and label creation

// ============================[END SCRIPT]============================
